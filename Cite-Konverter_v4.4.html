<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Favicons -->
  <link rel="icon" type="image/png" href="grafiken/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="grafiken/favicon.svg" />
  <link rel="shortcut icon" href="grafiken/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="grafiken/apple-touch-icon.png" />
<title>Cite-Konverter f√ºr Wikipedia</title>

<style>
  html{min-height:100%}
  :root{
    --transition: all .28s cubic-bezier(.2,.9,.3,1);
    --card-radius:18px;
    --glass: rgba(255,255,255,0.78);
    --glass-dark: rgba(12,12,14,0.78);
    --mono: ui-monospace, SFMono-Regular, Menlo, monospace;
  }
  html,body{min-height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
  body{display:flex;justify-content:center;align-items:flex-start;padding:28px;min-height:100vh;transition:var(--transition);background-attachment:fixed;background-size:cover}

  /* Themes */
  body.theme-sunset{background:linear-gradient(135deg,#C250F2 0%,#D76CD9 50%,#D977A5 100%)}
  body.theme-wikipedia{background:linear-gradient(180deg,#f6f7f8 0%,#eef6ff 100%)}
  body.theme-bluewave{background:linear-gradient(135deg,#012840 0%,#0468BF 60%,#99C8F2 100%)}
  body.theme-valley{background:linear-gradient(135deg,#387CA6 0%,#71A63C 55%,#BBF2F2 100%)}
  body.theme-simple{background:linear-gradient(180deg,#ffffff 0%,#f2f2f5 100%)}
  body.theme-spice{background:linear-gradient(135deg,#8C262E 0%,#D99982 60%,#732D14 100%)}
  body.theme-jadefruit{background:linear-gradient(135deg,#03A6A6 0%,#F27405 60%,#03A696 100%)}
  body.theme-hacker{background:linear-gradient(135deg,#205B73 0%,#49BF9E 60%,#307B8C 100%)}


  .wrap{width:100%;max-width:980px}
  .card{
    width:100%;
    background:var(--glass);
    backdrop-filter: blur(14px) saturate(140%);
    border-radius:var(--card-radius);
    padding:28px;
    box-shadow:0 20px 60px rgba(0,0,0,0.14);
    transition:var(--transition);
    color:#071029;
  }
  body.force-dark .card{background:var(--glass-dark); color:#e9eef6}

  h1{margin:0 0 10px;font-size:clamp(1.3rem,2.2vw,1.9rem);display:flex;align-items:center;gap:12px}
  .badge{display:inline-block;padding:6px 12px;border-radius:999px;font-weight:800;color:#fff;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.14)}
  .lead{margin:6px 0 16px;color:rgba(0,0,0,0.65)}

  details{margin:14px 0}
  details summary{cursor:pointer;font-weight:700;padding:8px;border-radius:8px}
  .options{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .option-compact{grid-column:1 / -1;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.segmented{display:inline-flex;border:1px solid rgba(0,0,0,.12);border-radius:10px;overflow:hidden}
.segmented button{padding:6px 10px;border:0;background:transparent;cursor:pointer;font-weight:600;line-height:1}
.segmented button+button{border-left:1px solid rgba(0,0,0,.08)}
body.dark .segmented{border-color:rgba(255,255,255,.18)}
body.dark .segmented button+button{border-left-color:rgba(255,255,255,.12)}
.segmented button[aria-pressed="true"]{background:rgba(0,0,0,.12);box-shadow:0 0 0 2px rgba(0,0,0,.10) inset}
body.dark .segmented button[aria-pressed="true"]{background:rgba(255,255,255,.18);box-shadow:0 0 0 2px rgba(255,255,255,.22) inset}
.segmented button{transition:background-color .15s ease, box-shadow .15s ease}
.segmented button:focus-visible{outline:2px solid #6aa9ff;outline-offset:2px}

  
body.force-dark .segmented button{color:#fff}
body.dark .segmented button{color:#fff}
@media(max-width:820px){.options{grid-template-columns:1fr}}

  .theme-grid{display:grid;grid-template-columns:repeat(4,minmax(140px,1fr));gap:10px;margin-top:6px}
  @media(max-width:980px){.theme-grid{grid-template-columns:repeat(3,minmax(140px,1fr))}}
  @media(max-width:740px){.theme-grid{grid-template-columns:repeat(2,minmax(140px,1fr))}}
  @media(max-width:480px){.theme-grid{grid-template-columns:1fr}}

  .theme-option{display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:10px;background:rgba(255,255,255,0.5);cursor:pointer;border:1px solid rgba(0,0,0,0.04)}
  .theme-option.active{transform:translateY(-3px);box-shadow:0 12px 30px rgba(0,0,0,0.12)}
  .swatch{width:62px;height:26px;border-radius:8px;flex-shrink:0}

  /* Buttons/Badge per theme (light) */
  body.theme-sunset .btn-main, body.theme-sunset .badge{background:linear-gradient(135deg,#C250F2,#D76CD9);}
  body.theme-wikipedia .btn-main, body.theme-wikipedia .badge{background:linear-gradient(90deg,#3366cc,#2b57b8); color:#fff;}
  body.theme-bluewave .btn-main, body.theme-bluewave .badge{background:linear-gradient(135deg,#023E73,#0468BF);}
  body.theme-valley .btn-main, body.theme-valley .badge{background:linear-gradient(135deg,#387CA6,#71A63C);}
  body.theme-simple .btn-main, body.theme-simple .badge{background:linear-gradient(90deg,#111827,#6b7280); color:#fff;}
  body.theme-spice .btn-main, body.theme-spice .badge{background:linear-gradient(135deg,#8C262E,#D99982);}
  body.theme-jadefruit .btn-main, body.theme-jadefruit .badge{background:linear-gradient(135deg,#03A6A6,#F27405);}
  body.theme-hacker .btn-main, body.theme-hacker .badge{background:linear-gradient(135deg,#205B73,#49BF9E);}


  /* Dark variants */
  body.force-dark.theme-sunset .btn-main, body.force-dark.theme-sunset .badge{background:linear-gradient(135deg,#8b2aa9,#9f4fb1)}
  body.force-dark.theme-wikipedia .btn-main, body.force-dark.theme-wikipedia .badge{background:linear-gradient(90deg,#1b355f,#214277)}
  body.force-dark.theme-bluewave .btn-main, body.force-dark.theme-bluewave .badge{background:linear-gradient(135deg,#012033,#02334f)}
  body.force-dark.theme-valley .btn-main, body.force-dark.theme-valley .badge{background:linear-gradient(135deg,#2f6b56,#3c7f3b)}
  body.force-dark.theme-simple .btn-main, body.force-dark.theme-simple .badge{background:linear-gradient(90deg,#e5e7eb,#9ca3af); color:#111;}
  body.force-dark.theme-spice .btn-main, body.force-dark.theme-spice .badge{background:linear-gradient(135deg,#260C06,#732D14)}
  body.force-dark.theme-jadefruit .btn-main, body.force-dark.theme-jadefruit .badge{background:linear-gradient(135deg,#731702,#03A696)}
  body.force-dark.theme-hacker .btn-main, body.force-dark.theme-hacker .badge{background:linear-gradient(135deg,#020D0C,#307B8C)}


  /* Input/Output area layout */
  .field{margin-bottom:18px}
  label.block{display:block;text-align:left;font-weight:700;margin-bottom:8px}
  .editor-wrap{position:relative;border-radius:12px;border:1px solid rgba(0,0,0,0.06);overflow:hidden;background:rgba(255,255,255,0.85)}
  body.force-dark .editor-wrap{background:rgba(8,8,10,0.32);border:1px solid rgba(255,255,255,0.06)}

  /* highlighted pre (shows behind textarea) */
  pre.highlight{
    margin:0;
    padding:14px;
    min-height:80px;
    font-family:var(--mono);
    font-size:13.5px;
    white-space:pre-wrap;
    word-wrap:break-word;
    color:inherit; /* visible base text */
    pointer-events:none;
    line-height:1.45;
  }

  /* textarea sits on top, text transparent but caret visible */
  textarea.overlay{
    position:absolute;left:0;top:0;right:0;padding:14px;
    width:100%;height:100%;min-height:80px;border:0;background:transparent;resize:vertical;
    font-family:var(--mono);font-size:13.5px;line-height:1.45;color:transparent !important; -webkit-text-fill-color: transparent; text-shadow: none !important;caret-color:transparent !important; -webkit-text-fill-color: transparent; text-shadow: none !important;
    z-index:3;
    outline:none;
  }
  /* make caret visible depending on theme */
  body:not(.force-dark) textarea.overlay{ caret-color:#071029 }
  body.force-dark textarea.overlay{ caret-color:#e9eef6 }

  /* styling tokens inside pre */
  .tok-template{color:#0b3b6f;font-weight:700}            /* template name */
  .tok-brace{color:#876acc;font-weight:700}               /* braces */
  .tok-param{color:#a63dff;font-weight:700}               /* parameter name */
  .tok-eq{color:#999}                                     /* equals sign */
  .tok-value{color:#0b2b12}                               /* value */
  .tok-url{color:#0455a4;text-decoration:underline}       /* urls */
  .tok-number{color:#b75d00}
  .tok-comment{color:#6b6b6b;font-style:italic}

  /* buttons */
  .btn-main{display:inline-block;padding:12px 18px;border-radius:12px;border:none;color:#fff;font-weight:700;cursor:pointer;box-shadow:0 10px 26px rgba(0,0,0,0.12);transition:var(--transition);width:100%}
  .btn-main:hover{transform:translateY(-3px);box-shadow:0 14px 34px rgba(0,0,0,0.18)}

  .btn-row{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:18px}
  #copyStatus{min-width:160px;text-align:center}

  /* conversion summary box */
  #conversionSummary{margin-top:12px;padding:12px;border-radius:10px;background:rgba(0,0,0,0.03);font-size:14px}
  body.force-dark #conversionSummary{background:rgba(255,255,255,0.03);}

  /* small responsive */
  @media(max-width:560px){ .swatch{width:48px;height:20px} pre.highlight{font-size:13px} textarea.overlay{font-size:13px} }
html,body{min-height:100%}

/* token styles for highlighting */
pre.highlight .tok-template{font-weight:800;color:#C250F2}
pre.highlight .tok-ref{color:#007CF0;font-weight:800}
pre.highlight .tok-attr{color:#D97706;font-weight:700}
pre.highlight .tok-val{color:#0F766E}
pre.highlight .tok-url{text-decoration:underline}


/* compact version badge */
#versionBadge{font-size:.72em;padding:2px 6px;border-radius:8px;align-self:flex-start;text-decoration:none;line-height:1}
#versionBadge:hover{transform:translateY(-1px) scale(1.02)}


/* Theme-bound H1 title colors (restored) */
body.theme-sunset h1 .title-text{
  background:linear-gradient(90deg,#C250F2,#D977A5);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
body.theme-bluewave h1 .title-text{
  background:linear-gradient(90deg,#007CF0,#00DFD8);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}

body.theme-simple h1 .title-text{
  background:linear-gradient(90deg,#000000,#6b7280);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
body.theme-spice h1 .title-text{
  background:linear-gradient(90deg,#8C262E,#D99982);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
body.theme-jadefruit h1 .title-text{
  background:linear-gradient(90deg,#03A6A6,#F27405);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
body.theme-hacker h1 .title-text{
  background:linear-gradient(90deg,#49BF9E,#307B8C);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
body.theme-valley h1 .title-text{
  background:linear-gradient(90deg,#28a745,#85e085);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
body.theme-wikipedia h1 .title-text{
  background:linear-gradient(90deg,#2b57b8,#3366cc);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}


/* Subline contrast */
#subline{color:rgba(0,0,0,.72)}
body.dark #subline{color:rgba(255,255,255,.85)}


/* Dark mode token tuning */
body.dark pre.highlight{color:rgba(255,255,255,.88)}
body.dark pre.highlight .tok-template{color:#E7B0FF}
body.dark pre.highlight .tok-ref{color:#7FB7FF}
body.dark pre.highlight .tok-attr{color:#FFC466}
body.dark pre.highlight .tok-val{color:#8FE7CF}
body.dark pre.highlight .tok-url{text-decoration:underline}


/* Animated flowing gradient for H1 title */
@keyframes flowGradient {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
body.theme-sunset h1 .title-text,
body.theme-bluewave h1 .title-text,
body.theme-valley h1 .title-text,
body.theme-wikipedia h1 .title-text {
  background-size: 400% 400%;
  animation: flowGradient 12s ease-in-out infinite;
}


/* Darkmode select spacing */
label[for="darkModeSelect"]{margin-right:4px}
#darkModeSelect{margin-left:6px;vertical-align:middle}


/* Dark-mode contrast fixes (intro + syntax) */
#subline { color: rgba(0,0,0,.72); }
body.dark #subline { color: rgba(255,255,255,.85); }

/* Ensure base text is visible in code highlight blocks */
pre.highlight { color: inherit; white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere; }
  pre.highlight span{ white-space: inherit; }
body.dark pre.highlight { color: rgba(255,255,255,.88); }

/* Brighter token colors in dark mode */
body.dark pre.highlight .tok-template{color:#E7B0FF}
body.dark pre.highlight .tok-ref{color:#7FB7FF}
body.dark pre.highlight .tok-attr{color:#FFC466}
body.dark pre.highlight .tok-val{color:#8FE7CF}
body.dark pre.highlight .tok-url{text-decoration:underline}


/* v2.5.12: Robust dark-mode contrast fixes (intro + syntax) */
.lead { color: rgba(0,0,0,.72); }
body.dark .lead, body.force-dark .lead { color: rgba(255,255,255,.90); }

/* Ensure base text is visible in code highlight blocks */
pre.highlight { color: inherit !important; }
body.dark pre.highlight, body.force-dark pre.highlight { color: rgba(255,255,255,.92) !important; }

/* Brighter token colors in dark/forced-dark */
body.dark pre.highlight .tok-template,
body.force-dark pre.highlight .tok-template{ color:#E7B0FF !important; }
body.dark pre.highlight .tok-ref,
body.force-dark pre.highlight .tok-ref{ color:#8FC2FF !important; }
body.dark pre.highlight .tok-attr,
body.force-dark pre.highlight .tok-attr{ color:#FFCC80 !important; }
body.dark pre.highlight .tok-val,
body.force-dark pre.highlight .tok-val{ color:#9DF0D8 !important; }
body.dark pre.highlight .tok-url,
body.force-dark pre.highlight .tok-url{ text-decoration: underline !important; }


/* v2.5.13: brighten dark-mode syntax colors */
body.dark pre.highlight .tok-template,
body.force-dark pre.highlight .tok-template{ color:#F2B7FF !important; }  /* brighter for `{{cite web` */
body.dark pre.highlight .tok-val,
body.force-dark pre.highlight .tok-val{ color:#B8FFE9 !important; }      /* brighter for parameter values (e.g., author names) */
/* ensure ref tags share same color for open/close */
body.dark pre.highlight .tok-ref,
body.force-dark pre.highlight .tok-ref{ color:#8FC2FF !important; font-weight:800; }


/* v2.5.19.1: Darkmode visibility for highlight blocks */
body.dark pre.highlight, body.force-dark pre.highlight { color:#ffffff !important; }
body.dark pre.highlight .tok-template, body.force-dark pre.highlight .tok-template { color:#FFD4FF !important; font-weight:800; }
body.dark pre.highlight .tok-ref, body.force-dark pre.highlight .tok-ref { color:#9BD0FF !important; font-weight:800; }


/* Bootstrap highlight safety: show textarea text until overlay is ready */
textarea.overlay{ color: inherit !important; caret-color: auto !important; }
.hl-ready textarea.overlay{ color: transparent !important; caret-color: transparent !important; }
</style>
</head>
<body class="theme-sunset">
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="heading">
      <h1 id="heading"><span class="title-text">Cite-Konverter f√ºr Wikipedia</span> <a href="#changelog" id="versionBadge" class="badge">v4.4</a></h1>
      <p class="lead">Konvertiert Wikipedia-Vorlagen in das deutsche Schema: {{cite web}}, {{cite book}}, {{cite journal}} und {{cite encyclopedia}} ‚Üí {{Internetquelle}} bzw. {{Literatur}}. Bitte jeden konvertierten Beleg vor dem Einf√ºgen manuell pr√ºfen.</p>

      <details>
        <summary>‚öôÔ∏è Optionen</summary>
        <div class="options" role="group" aria-label="Einstellungen">
          <label class="inline"><input type="checkbox" id="useTodayAbruf" checked /> <span class="info">Abrufdatum automatisch auf heute setzen</span> (<span id="todayLabel"></span>)</label>
          <label class="inline"><input type="checkbox" id="stripArchiveIfLive" checked /> <span class="info">Archiv-Parameter entfernen, wenn URL aktiv (<code>url-status=live</code>)</span></label>
          <label style="grid-column:1/-1" class="inline"><input type="checkbox" id="suppressGerman" checked /> <span class="info"><code>Sprache=de</code> unterdr√ºcken</span> <button id="langInfoToggle" style="background:none;border:none;color:#0645AD;cursor:pointer">‚ÑπÔ∏è</button></label>
          <div id="langInfo" style="display:none;margin-left:6px;font-size:13px;grid-column:1/-1">Deutsch (de) wird standardm√§√üig nicht ausgegeben. Fremdsprachen erscheinen als Sprachcode (zweistellig). Mit dieser Option kann die Unterdr√ºckung deaktiviert werden.</div>

          <label class="inline"><input type="checkbox" id="fullLangCodes" /> <span class="info">Ungek√ºrzte Sprachcodes ausgeben (z. B. en-GB)</span></label>
          <label class="inline"><input type="checkbox" id="autoCopy" /> <span class="info">Konvertierte Ausgabe direkt in Zwischenablage kopieren</span></label>

          
<div class="option-compact">
<label class="inline" for="darkModeSelect">Darkmode:</label>
<div id="darkModeSegmented" class="segmented" role="group" aria-label="Darkmode-Modus"><button type="button" data-value="auto" aria-pressed="false">Auto</button><button type="button" data-value="on" aria-pressed="false">An</button><button type="button" data-value="off" aria-pressed="false">Aus</button></div>
<select id="darkModeSelect" class="visually-hidden">
  <option value="auto">Automatisch (System)</option>
  <option value="on">Immer an</option>
  <option value="off">Immer aus</option>
</select>
</div>

          <label class="inline"><input type="checkbox" id="overrideLang" /> <span class="info">Sprache manuell √ºberschreiben</span></label>

          <div id="langSelectContainer" style="display:none; grid-column:1/-1">
            <label style="display:block;font-weight:700;margin-bottom:6px">Sprache w√§hlen (√ºberschreibt Heuristik)</label>
            <select id="langSelect" aria-label="Sprache w√§hlen">
              <option value="">‚Äî w√§hlen ‚Äî</option>
              <option value="de">üá©üá™ Deutsch ‚Äî de</option>
              <option value="en">üá¨üáß English ‚Äî en</option>
              <option value="fr">üá´üá∑ Fran√ßais ‚Äî fr</option>
              <option value="es">üá™üá∏ Espa√±ol ‚Äî es</option>
              <option value="it">üáÆüáπ Italiano ‚Äî it</option>
              <option value="nl">üá≥üá± Nederlands ‚Äî nl</option>
            </select>
          </div>
          
          <div style="grid-column:1/-1">
            <div class="theme-grid" role="list">
              <div class="theme-option" data-theme="sunset" role="button" tabindex="0"><div class="swatch" style="background:linear-gradient(90deg,#C250F2,#D76CD9,#D977A5)"></div><div>Sunset on the Beach</div></div>
              <div class="theme-option" data-theme="wikipedia" role="button" tabindex="0"><div class="swatch" style="background:linear-gradient(90deg,#5a7bd8,#89a8ff,#b9c9ff)"></div><div>Wikipedia (modern)</div></div>
              <div class="theme-option" data-theme="bluewave" role="button" tabindex="0"><div class="swatch" style="background:linear-gradient(90deg,#0468BF,#023E73,#012840)"></div><div>Blue Wave</div></div>
              <div class="theme-option" data-theme="valley" role="button" tabindex="0"><div class="swatch" style="background:linear-gradient(90deg,#387CA6,#71A63C,#BBF2F2)"></div><div>The Valley</div></div>
              <div class="theme-option" data-theme="simple" role="button" tabindex="0"><div class="swatch" style="background:linear-gradient(90deg,#000000,#6b7280,#ffffff)"></div><div>Simple</div></div>
              <div class="theme-option" data-theme="spice" role="button" tabindex="0"><div class="swatch" style="background:linear-gradient(90deg,#8C262E,#D99982,#732D14)"></div><div>Spice</div></div>
              <div class="theme-option" data-theme="jadefruit" role="button" tabindex="0"><div class="swatch" style="background:linear-gradient(90deg,#03A6A6,#F27405,#03A696)"></div><div>Jade Fruit</div></div>
              <div class="theme-option" data-theme="hacker" role="button" tabindex="0"><div class="swatch" style="background:linear-gradient(90deg,#205B73,#49BF9E,#307B8C)"></div><div>Hacker</div></div>
            </div>
          </div>

        </div>
      </details>

      <!-- INPUT -->
      <div class="field">
        <label class="block">Eingabe</label>
        <div class="editor-wrap" id="inputWrap" style="min-height:120px">
          <pre id="inputHighlight" class="highlight" aria-hidden="true"></pre>
          <textarea id="inputText" class="overlay" placeholder="Hier den &lt;ref&gt;‚Ä¶&lt;/ref&gt; Block oder die {{cite ‚Ä¶}}-Vorlage einf√ºgen"></textarea>
        </div>
      </div>

      <div class="btn-row" style="margin-bottom:22px">
        <button id="convertBtn" class="btn-main">Einzelnachweis konvertieren</button>
      </div>

      <!-- OUTPUT -->
      <div class="field">
        <label class="block">Ausgabe</label>
        <div class="editor-wrap" id="outputWrap" style="min-height:120px">
          <pre id="outputHighlight" class="highlight" aria-hidden="true"></pre>
          <textarea id="outputText" class="overlay" readonly></textarea>
        </div>
      </div>

      <div class="btn-row">
        <button id="copyBtn" class="btn-main">In die Zwischenablage kopieren</button>
        <div id="copyStatus" style="align-self:center"></div>
      </div>

      <details id="changelog" style="margin-top:12px">
        <summary>üìú Versionsverlauf</summary>
        <ul>
              <li><strong>v4.4</strong> (2025-09-11): Kleinere Fehlerkorrekturen wie doppeltes Leerzeichen und fehlende Zitat-Konvertierungen. Weitere Erg√§nzungen bei getDisplaySiteNameFromUrl.</li>
              <li><strong>v4.3.5</strong> (2025-09-10): Stabilisierung ‚Äì Eingabetext sichtbar bis Highlight geladen; robustes Rebinding f√ºr Highlight & Konvertieren (Fallback aktiv).</li>
              <li><strong>v4.3.1</strong> (2025-09-10): {{Internetquelle}} ‚Äì Priorit√§t jetzt work ‚Üí website ‚Üí publisher (falls kein website/work) ‚Üí Domain-Fallback aus URL.</li>
              <li><strong>v4.3</strong> (2025-09-10): {{Internetquelle}} ‚Äì Fallback f√ºr ‚Äûwerk‚Äú: wenn website/work fehlen ‚Üí Domain aus der URL (z.‚ÄØB. nytimes.com). Plus Auto‚ÄëMapping einiger Domains (z.‚ÄØB. nytimes.com ‚Üí The New York Times).</li>
              <li><strong>v4.2.1</strong> (2025-09-10): {cite news}/{cite web} ‚Üí {{Internetquelle}}: Reihenfolge korrigiert; Sprache per language/Override/W√∂rterliste; Abruf=heute (Option); ‚Äûwork‚Äú‚Üí‚Äûwerk‚Äú; Doppel‚ÄëLeerzeichen nach ‚ÄûInternetquelle‚Äú entfernt.</li>
              <li><strong>v4.2</strong> (2025-09-10): Fix f√ºr {{!}} u. √§. Mapping: website‚Üíwerk & publisher‚Üíhrsg, Fallback publisher‚Üíwerk wenn kein website.</li>
              <li><strong>v4.1.1</strong> (2025-09-10): {{Internetquelle}} ‚Äì feste Parameter-Reihenfolge erzwungen + Sprachcodes gek√ºrzt (z.‚ÄØB. en‚ÄëUS ‚Üí en), falls ‚ÄûUngek√ºrzte Sprachcodes‚Äú aus.</li>
              <li><strong>v4.1</strong> (2025-09-08): cite web ‚Äì Titel: Leerzeichen um Gedankenstrich normalisiert (genau ein Leerzeichen vor/nach ‚Äû‚Äì‚Äú).</li>
              <li><strong>v4.0.10</strong> (2025-09-06): Darkmode-Schalter: Beschriftung ‚ÄûAuto/An/Aus‚Äú in Darkmode wei√ü; Changelog: Trenner f√ºr 4.x und 3.x hinzugef√ºgt.</li>
              <li><strong>v4.0.9</strong> (2025-09-06): Intro erg√§nzt ({{cite journal}}, {{cite encyclopedia}}); Changelog bereinigt.</li>
              <li><strong>v4.0.8</strong> (2025-09-06): Fix Doppel-Leerzeichen nach ‚Äû{{Internetquelle‚Äú (Output nun ‚Äû{{Internetquelle |‚Ä¶‚Äú).</li>
              <li><strong>v4.0.7</strong> (2025-09-06): Parser-Fix f√ºr verschachtelte Templates ‚Äì standalone-Erkennung nutzt jetzt brace‚ÄëDepth; verhindert abgeschnittene Konvertierung bei {{google books}}.</li>
              <li><strong>v4.0.6</strong> (2025-09-06): Online-Feld bereinigt ‚Äì {{google books}}-Templates werden aus URL/Online entfernt (kein Online-Ausgabe), in allen Konvertern (web/book/journal/encyclopedia); keine UI-√Ñnderungen.</li>
              <li><strong>v4.0.5</strong> (2025-09-06): cite encyclopedia ‚Äì Hrsg unterst√ºtzt nun ‚Äûeditor-first/last‚Äú (ohne Index) und ‚ÄûeditorN-first/last‚Äú; robustere Google-Books/URL-Heuristik; keine UI-√Ñnderungen.</li>
              <li><strong>v4.0.4</strong> (2025-09-06): cite encyclopedia Mapping finalisiert (Sammelwerk=encyclopedia, Reihe=series, Band=volume, Verlag=publisher, Datum‚ÄëFallback, Sprache-Heuristik). R√ºckbau auf buildLiteratur().</li>
              <li><strong>v4.0.3</strong> (2025-09-05): cite encyclopedia korrigiert (Sammelwerk=encyclopedia, Reihe=series, Band=volume, Verlag=publisher, Datum‚ÄëFallback, Sprache ‚Äûen‚Äú bei Google‚ÄëBooks), Dispatcher‚ÄëHook erg√§nzt. Smoke‚ÄëTest entfernt.</li>
              <li><strong>v4.0.0.2</strong> (2025-09-05): Fix cite encyclopedia ‚Äì Sammelwerk=encyclopedia; Reihe=series; Band=volume; Verlag=publisher; Datum aus date/publication-date/year; ISBN/Seiten korrekt.</li>
              <li><strong>v4.0.0.1</strong> (2025-09-05): Fix cite encyclopedia ‚Äì Autoren (first/last & editor1-first Schema), Hrsg (beide Schemata), series‚ÜíSammelwerk, Datum-Fallback (z.‚ÄØB. 2007a), Sprache=‚Äûen‚Äú bei Google‚ÄëBooks‚ÄëURL; keine UI-√Ñnderungen.</li>
              <li><strong>v4.0.0</strong> (2025-09-05): Neue Variante ‚Äì {{cite encyclopedia}} ‚Üí {{Literatur}} (Autor/Hrsg/Kapitel/Titel/Ort/Verlag/Datum/Abruf/IDs/Seiten). Keine UI-/Design-√Ñnderungen.</li>
              <li class="major-separator">‚Äî Version 3.x ‚Äî</li>
              <li><strong>v3.0.3.0</strong> (2025-09-05): Dev‚ÄëFeature: Smoke‚ÄëTest‚ÄëModus (?test=1 oder Alt+D). Tests laufen nur in der Konsole; keine UI‚Äë√Ñnderungen.</li>
              <li><strong>v3.0.2.22</strong> (2025-09-05): Bugfix cite web ‚Äì Aufruf von toISODateFlexible entfernt (nicht definiert) und durch toISODate ersetzt.</li>
              <li><strong>v3.0.2.21</strong> (2025-09-05): Bugfix cite web ‚Äì defekte Erkennung/Zuordnung ersetzt (robuste Aliase, saubere Parametermappung). Sonst keine √Ñnderungen.</li>
              <li><strong>v3.0.2.20</strong> (2025-09-05): Konverter‚ÄëZusammenfassung (UI + JS) entfernt. Sonst keine √Ñnderungen.</li>
              <li><strong>v3.0.2.14</strong> (2025-09-05): Internetquelle-Summary: "Titel: ersetzt {*} ‚Üí ‚Ä¢" nur noch, wenn tats√§chlich ersetzt; sonst "Titel √ºbernommen".</li>
              <li><strong>v3.0.2.13</strong> (2025-09-04): Kritischer Fix ‚Äì Builder repariert und Journal-Konverter liefert detaillierte Summary-Logs; keine UI-/Theme-√Ñnderungen.</li>
              <li><strong>v3.0.2</strong> (2025-09-04): JS-Bereinigung f√ºr <code>cite journal</code> (dupl./abgeschnittene Fragmente entfernt); Klick auf ‚ÄûKonvertieren‚Äú liefert zuverl√§ssig Output.</li>
              <li><strong>v3.0.1</strong> (2025-09-03): Dispatcher-Fix: Branch f√ºr <code>cite journal</code> korrekt registriert.</li>
              <li><strong>v3.0.0</strong> (2025-09-03): Neue Vorlage: <code>{{cite journal}}</code> ‚Üí <code>{{Literatur}}</code> (Autoren/Editoren/√úbersetzer, Datum/Originaljahr, Sammelwerk/Band/Nummer, Seiten, Sprache, Online/Abruf, IDs, Typ, Zitat).</li>
              <li class="major-separator">‚Äî Version 2.x ‚Äî</li>
              <li><strong>v2.5.19.1</strong> (2025-09-01): Theme-Grid auf max. 4 Kacheln pro Reihe begrenzt (3/2/1 Spalten bei kleineren Viewports); Wikipedia-Button erh√§lt wieder ausreichenden Innenabstand.</li>
              <li><strong>v2.5.19</strong> (2025-09-01): Neue Themes: Simple (schwarz/wei√ü/grau), Spice, Jade Fruit, Hacker ‚Äì inkl. H1-/Button-/Badge-Anpassungen.</li>
              <li><strong>v2.5.18.4</strong> (2025-09-01): Highlighter neu aufgebaut (verlustfrei): Template-Name mit Leerzeichen vor erster Pipe sichtbar; Overlay-Text deckt den vollen Inhalt.</li>
              <li><strong>v2.5.18.3</strong> (2025-09-01): Anzeige-Bug behoben: Leerzeichen vor der ersten Pipe bleibt bei ‚Äû{{cite ‚Ä¶ |‚Äú erhalten (Tokenizer erh√§lt Nachlauf-Whitespace vor <code>|</code>/<code>}</code>).</li>
              <li><strong>v2.5.18.2</strong> (2025-09-01): Zeilenumbruch in Eingabe-/Ausgabe-Highlight wieder aktiv (Wrap wie Textfelder); CSS: <code>pre.highlight</code> auf <code>pre-wrap</code> umgestellt, Spans erben <code>white-space</code>.</li>
              <li><strong>v2.5.18.1</strong> (2025-09-01): Hintergrund-Verlauf f√ºllt die gesamte Seite (auch bei aufgeklapptem Versionsverlauf); Darstellung: fehlendes Leerzeichen nach ‚Äû{cite ‚Ä¶‚Äú bzw. vor dem ersten Pipe behoben; Konvertierung: ‚Äû{*}‚Äú im title ‚Üí ‚Äû‚Ä¢‚Äú (U+2022).</li>
              <li><strong>v2.5.18</strong> (2025-09-01): Darkmode-Auswahl als Segmented-Control (Auto/An/Aus) erg√§nzt; bestehendes Dropdown bleibt (visually-hidden) und wird bidirektional synchronisiert (Klick & Tastatur); aktiver Zustand deutlicher hervorgehoben.</li>
              <li><strong>v2.5.17</strong> (2025-09-01): Darkmode-Option kompakter: Label und Auswahl stehen jetzt nebeneinander (Wrapper <code>.option-compact</code>) f√ºr bessere Lesbarkeit.</li>
              <li><strong>v2.5.16</strong> (2025-09-01): Highlighting-Fix: <code>&lt;/ref&gt;</code> wird exakt wie <code>&lt;ref&gt;</code> und <code>&lt;ref name="‚Ä¶"&gt;</code> eingef√§rbt (robuster Regex im Highlighter).</li>
              <li><strong>v2.5.15</strong> (2025-08-31): Darkmode-Sichtbarkeit: Basistext in Codebl√∂cken auf #fff, ‚Äû{{cite web‚Äú}} heller; </ref> wie <ref> eingef√§rbt.</li>
              <li><strong>v2.5.13</strong> (2025-08-31): Darkmode-Syntax aufgehellt: ‚Äû{{cite web‚Äú}} (Template) & Parametervalue heller; </ref> nun gleiche Farbe wie <code><ref></code> & <code><ref name="‚Ä¶"></code>.</li>
              <li><strong>v2.5.12</strong> (2025-08-31): Darkmode-Kontraste (Intro & Syntax) breit abgesichert (.dark & .force-dark; .lead statt #subline). Keine anderen √Ñnderungen.</li>
              <li><strong>v2.5.11</strong> (2025-08-31): Darkmode-Kontraste f√ºr Intro & Syntax-Highlighting aufgehellt.</li>
              <li><strong>v2.5.10</strong> (2025-08-31): Darkmode-Info-Icon entfernt; Abstand Label/Dropdown optimiert; Changelog vollst√§ndig wiederhergestellt (keine Eintr√§ge gel√∂scht).</li>
              <li><strong>v2.5.9</strong> (2025-08-31): H1-Verlauf animiert (12s ease-in-out, sanft flie√üend).</li>
              <li><strong>v2.5.8</strong> (2025-08-31): H1-Farben (theme-gebunden) wiederhergestellt; Badge dezenter; Darkmode-Kontraste f√ºr Intro & Highlighting verbessert.</li>
              <li><strong>v2.5.7</strong> (2025-08-31): Darkmode-Auswahl mit ‚ÑπÔ∏è-Info-Hinweis (Hover-Tooltip) erg√§nzt.</li>
              <li><strong>v2.5.6</strong> (2025-08-31): Option ‚ÄûDarkmode‚Äú √ºberarbeitet: Automatisch (System), Immer an, Immer aus.</li>
              <li><strong>v2.5.5b</strong> (2025-08-31): Trenner im Changelog im Darkmode heller.</li>
              <li><strong>v2.5.5</strong> (2025-08-31): Trenner im Changelog f√ºr Major-Versionen hinzugef√ºgt.</li>
              <li><strong>v2.5.4</strong> (2025-08-31): Subline-Text ge√§ndert; bessere Lesbarkeit im Darkmode.</li>
              <li><strong>v2.5.3</strong> (2025-08-31): Smoothflow ‚Äì weiche H1-Animation (400% Hintergrund; 12s ease-in-out).</li>
              <li><strong>v2.5.2</strong> (2025-08-31): Designpolitur ‚Äì H1-Verlauf animiert (erste Version).</li>
              <li><strong>v2.5.1</strong> (2025-08-31): Badge-Link zum Changelog; H1 theme-gebunden; Syntax-Highlighting & Gradient-Fix.</li>
              <li><strong>v2.5</strong> (2025-08-30): Syntax-Highlighting f√ºr Eingabe & Ausgabe; verst√§ndliche Konvertierungs-Zusammenfassung; Design & Konvertierungsskript unber√ºhrt.</li>
              <li><strong>v2.4.7</strong> (2025-08-30): Darkmode f√ºr Wikipedia-Theme deutlich dunkler gestaltet (#1a1a1a ‚Üí #2a2a2a).</li>
              <li><strong>v2.4.6</strong> (2025-08-30): Theme-Buttons & Badge passen sich an; Darkmode-Varianten f√ºr alle Themes; Farbverlauf bleibt bis unten sichtbar; Badge wieder styled; Changelog erweitert.</li>
              <li><strong>v2.4.5</strong> (2025-08-29): Sprachheuristik erg√§nzt (mehr Sprachen erkannt), Checkbox mit Info-Icon, Flaggen bei Sprachoption, mehr Abstand zwischen Buttons/Textareas, Hover-Effekte verbessert.</li>
              <li><strong>v2.4.4</strong> (2025-08-30): Vollst√§ndige Integration der robusten Konvertierungslogik (fixed14) in das neue Design; Copy-Button styled + animiert; Theme-Wechsel repariert; Darkmode-Varianten pro Theme erg√§nzt; kleine UI-Optimierungen (Hover/Focus, Copy-Feedback, responsive Buttons).</li>
              <li><strong>v2.4.3</strong> (2025-08-29): Bugfix-Version, Konvertierung funktioniert wieder; Design noch unvollst√§ndig.</li>
              <li><strong>v2.4.2</strong> (2025-08-29): Versuch der Integration, aber Teile der Logik fehlten.</li>
              <li><strong>v2.4.1</strong> (2025-08-29): Bugfix f√ºr Erkennung von cite web/news/magazine/book auch mit Parametern; Darkmode-Override-Toggle und Theme-Auswahl mit Farbverl√§ufen.</li>
              <li><strong>v2.4</strong> (2025-08-29): Redesign (Claude-Version) mit modernem Glasmorphism-UI.</li>
              <li><strong>v2.3</strong> (2025-08-28): Neues Theme-System (4 Designs mit LocalStorage), Optionen erweitert (Sprachcodes ungek√ºrzt, Direktkopie, Info-Hinweis per Klick), kleinere Textareas, Favicon gefixt. Neueste Version oben gelistet.</li>
              <li><strong>v2.2</strong> (2025-08-28): Einstellungsmen√º in <code>details</code>-Block; neue Checkbox ‚ÄûSprache=de unterdr√ºcken‚Äú.</li>
              <li><strong>v2.1.2</strong> (2025-08-28): Info-Hinweis zu Sprache=de.</li>
              <li><strong>v2.1.1</strong> (2025-08-28): Normalisierung Sprachcodes, Deutsch wird unterdr√ºckt.</li>
              <li><strong>v2.1</strong> (2025-08-28): ISBN-Gruppierung, strengere Sprachheuristik.</li>
              <li><strong>v2.0</strong> (2025-08-28): Neue Konvertierung {{cite book}} ‚Üí {{Literatur}}.</li>
        </ul>
      </details>
    </div>
  </div>

<script>
/* =========================================================================
   v2.5 ‚Äî vollst√§ndiges Skript
   - Original-Konvertierungslogik (erhalten und erweitert)
   - Highlighting f√ºr input/output (nur visuell)
   - Conversion summary (verst√§ndliche Meldungen)
   ========================================================================= */

(function(){

  /* ---------------- Utilities ---------------- */
  function todayISO(){ return new Date().toISOString().slice(0,10); }

  function escapeHtml(s){
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function toISODate(ds){
    if(!ds) return '';
    ds = String(ds).trim();
    const monthMap = {
      january:'01', february:'02', march:'03', april:'04', may:'05', june:'06',
      july:'07', august:'08', september:'09', october:'10', november:'11', december:'12',
      januar:'01', februar:'02', 'm√§rz':'03', maerz:'03', april:'04', mai:'05', juni:'06',
      juli:'07', august:'08', september:'09', oktober:'10', november:'11', dezember:'12'
    };
    let m;
    if((m = ds.match(/^(\d{1,2})\s+([A-Za-z√§√∂√º√Ñ√ñ√ú]+)\s+(\d{4})$/))){
      const day = String(m[1]).padStart(2,'0');
      const mon = monthMap[m[2].toLowerCase()] || m[2];
      return `${m[3]}-${mon}-${day}`;
    }
    if((m = ds.match(/^([A-Za-z√§√∂√º√Ñ√ñ√ú]+)\s+(\d{1,2}),\s*(\d{4})$/))){
      const mon = monthMap[m[1].toLowerCase()] || m[1];
      const day = String(m[2]).padStart(2,'0');
      return `${m[3]}-${mon}-${day}`;
    }
    if(/^\d{4}-\d{2}-\d{2}$/.test(ds)) return ds;
    if(/^\d{4}-\d{2}$/.test(ds)) return ds;
    if(/^\d{4}$/.test(ds)) return ds;
    return ds;
  }

  function extractYear(s){ if(!s) return ''; const m = String(s).match(/(\d{4})/); return m?m[1]:String(s); }
  function normalizeEdition(ed){ if(!ed) return ''; let e=String(ed).trim(); e=e.replace(/(\d+)\s*(st|nd|rd|th)\b/gi,(m,n)=>`${n}.`); e=e.replace(/\bAufl\.?/i,'').trim(); return e; }
  function normalizePages(p){ if(!p) return ''; let s=String(p); s=s.replace(/(\d+)\s*-\s*(\d+)/g,(m,a,b)=>{ const x=parseInt(a,10), y=parseInt(b,10); return x<y?`${a}\u2013${b}`:`${a}-${b}`; }); return s; }
  function normalizeISBN(isbn){ if(!isbn) return ''; return String(isbn).trim().replace(/x$/i,'X').replace(/\s+/g,' '); }

  function looksEnglish(text){
    if(!text) return false;
    return /(\bthe\b|\band\b|\bof\b|\bto\b|\bwith\b|\bfor\b|\bfrom\b|\bin\b|\bis\b|\bthis\b|\bthat\b|guardian|times|news|daily|york|press|telegraph|washington post|new york times)/i.test(text);
  }

  function detectLanguage(text){
    if(!text) return '';
    const t = String(text).toLowerCase();

    if(/\b(der|die|das|und|nachrichten|zeitung|zeitschrift|deutschland)\b/.test(t)) return 'de';
    if(/\b(le|la|les|des|du|revue|france|fran√ßais)\b/.test(t)) return 'fr';
    if(/\b(el|la|los|las|diario|noticias|espa√±a|espa√±ol)\b/.test(t)) return 'es';
    if(/\b(il|lo|la|giornale|quotidiano|italia|italiano)\b/.test(t)) return 'it';
    if(/\b(de|het|nieuws|krant|nederland|nederlands)\b/.test(t)) return 'nl';
    if(looksEnglish(t)) return 'en';
    return '';
  }

  /* split top-level pipes while ignoring pipes inside [[...]] or {{...}} */
  function splitTopLevelPipes(s){
    const tokens = []; let buf=''; let depthLink=0, depthTpl=0;
    for(let i=0;i<s.length;i++){
      const ch=s[i], nxt=s[i+1];
      if(ch==='[' && nxt==='['){ depthLink++; buf+='[['; i++; continue; }
      if(ch===']' && nxt===']' && depthLink>0){ depthLink--; buf+=']]'; i++; continue; }
      if(ch==='{' && nxt==='{'){ depthTpl++; buf+='{{'; i++; continue; }
      if(ch==='}' && nxt==='}' && depthTpl>0){ depthTpl--; buf+='}}'; i++; continue; }
      if(ch==='|' && depthLink===0 && depthTpl===0){ tokens.push(buf); buf=''; continue; }
      buf+=ch;
    }
    tokens.push(buf);
    return tokens;
  }

  function parseTemplateParams(templateText){
    const innerMatch = templateText.match(/^\s*\{\{([\s\S]*?)\}\}\s*$/);
    if(!innerMatch) return { name:'', params:{}, raw:templateText };
    const inner = innerMatch[1];
    const tokens = splitTopLevelPipes(inner);
    const name = (tokens.shift()||'').trim();
    const params = {};
    for(const tok of tokens){
      const eq = tok.indexOf('=');
      if(eq === -1) continue;
      const key = tok.slice(0,eq).trim().toLowerCase();
      const val = tok.slice(eq+1).trim();
      if(key) params[key] = val;
    }
    return { name, params, raw: templateText };
  }

  /* builders (same order as before) */
  
function buildInternetquelle(finalParams){
  const order = [
    'autor','url','titel','werk','hrsg','datum','sprache',
    'archiv-url','archiv-datum','abruf','abruf-verborgen',
    'kommentar','zitat','format'
  ];
  const parts = []; const used = new Set();
  for (const k of order){
    if (Object.prototype.hasOwnProperty.call(finalParams, k)){
      parts.push('|' + k + '=' + (finalParams[k] ?? ''));
      used.add(k);
    }
  }
  Object.keys(finalParams).sort().forEach(k => {
    if (!used.has(k)) parts.push('|' + k + '=' + finalParams[k]);
  });
  return '{{Internetquelle ' + parts.join(' ') + '}}';
}


  
function buildLiteratur(finalParams){
  const order = [
    'Autor','Titel','TitelErg','Hrsg','√úbersetzer','Sammelwerk','Reihe','Band','Nummer',
    'Ort','Verlag','Datum','Originaljahr','Auflage','Seiten','Spalten','Kapitel',
    'Sprache','Online','Abruf','Format',
    'ISBN','ISSN','DOI','JSTOR','LCCN','OCLC','PMID','PMC','arXiv','bibcode','URN','ID',
    'Typ','Umfang','Lizenznummer','Zitat'
  ];
  const parts = []; const used = new Set();
  for (const k of order){
    if (Object.prototype.hasOwnProperty.call(finalParams, k)){
      parts.push('|' + k + '=' + (finalParams[k] ?? ''));
      used.add(k);
    }
  }
  Object.keys(finalParams).sort().forEach(k => {
    if (!used.has(k)) parts.push('|' + k + '=' + finalParams[k]);
  });
  return '{{Literatur ' + parts.join(' ') + '}}';
}


  /* helpers */
  function collectPersons(params, firstPrefix, lastPrefix){
    const people = []; const numbered = [];
    Object.keys(params).forEach(k=>{
      const m = k.match(new RegExp('^' + lastPrefix.replace(/[-]/g,'[-]') + '(\\d*)$'));
      if(m) numbered.push(m[1] || '');
    });
    numbered.sort((a,b)=>{ const ai = a===''?0:parseInt(a,10); const bi = b===''?0:parseInt(b,10); return ai - bi; });
    const used = new Set();
    for(const suf of numbered){
      const f = params[firstPrefix + suf] || '';
      const l = params[lastPrefix + suf] || '';
      const name = (f + ' ' + l).trim();
      if(name){ people.push(name); used.add(firstPrefix+suf); used.add(lastPrefix+suf); }
    }
    if(!used.has(firstPrefix) && !used.has(lastPrefix)){
      const f = params[firstPrefix] || '';
      const l = params[lastPrefix] || '';
      const name = (f + ' ' + l).trim();
      if(name) people.push(name);
    }
    return people;
  }

  function normalizeLangCode(code, fullMode){
    if(!code) return '';
    code = String(code).trim();
    if(!fullMode){
      if(code.includes('-')) return code.split('-')[0].toLowerCase();
      return code.toLowerCase().slice(0,2);
    }
    return code.toLowerCase();
  }

  function chooseLanguage(langChoice, explicitLang, titleText, workText, overrideChecked, fullLangCodes){
    if(overrideChecked && langChoice && langChoice !== '') return normalizeLangCode(langChoice, fullLangCodes);
    if(explicitLang) return normalizeLangCode(explicitLang, fullLangCodes);
    const combined = [titleText||'', workText||''].join(' ');
    const auto = detectLanguage(combined);
    if(auto) return normalizeLangCode(auto, fullLangCodes);
    if(looksEnglish(combined)) return 'en';
    return '';
  }

  /* ---------- Conversion functions (RETURN {output, log}) ---------- */

  
// === Helper: derive display site name from URL when website/work missing ===
function getDomainFromUrl(url){
  try{
    var u = new URL(url);
    var host = (u.hostname || '').replace(/^www\./i, '');
    // reduce to eTLD+1 for common multi-part TLDs
    var multi = ['co.uk','com.au','co.jp','co.nz','com.br','co.in','co.za','com.cn','com.mx','com.tr'];
    for(var i=0;i<multi.length;i++){
      if(host.toLowerCase().endsWith('.'+multi[i])){
        var parts = host.split('.');
        return parts.slice(-3).join('.'); // e.g. news.bbc.co.uk -> bbc.co.uk
      }
    }
    var parts = host.split('.');
    if(parts.length>=2) return parts.slice(-2).join('.'); // sub.site.com -> site.com
    return host || '';
  }catch(e){
    try{
      var m = String(url||'').match(/^[a-z]+:\/\/([^\/]+)/i);
      if(m) return m[1].replace(/^www\./i,'');
    }catch(_e){}
    return '';
  }
}
function getDisplaySiteNameFromUrl(url){
  var domain = getDomainFromUrl(url);
  if(!domain) return '';
  var map = {
    '20minutos.es':'20 Minutos',
    'abc.es':'ABC',
    'abc.net.au':'ABC News Australia',
    'abclocal.go.com':'ABC Local',
    'abcnews.go.com':'ABC News',
    'abcsports.go.com':'ABC Sports',
    'accesshollywood.com':'Access Hollywood',
    'ad.nl':'Algemeen Dagblad',
    'adage.com':'Ad Age',
    'adelaidenow.com.au':'The Advertiser',
    'adnkronos.com':'Adnkronos',
    'adweek.com':'Adweek',
    'afp.com':'Agence France-Presse',
    'agi.it':'AGI',
    'ajc.com':'The Atlanta Journal-Constitution',
    'al.com':'AL.com',
    'aljazeera.com':'Al Jazeera',
    'allmusic.com':'AllMusic',
    'allure.com':'Allure',
    'alternet.org':'AlterNet',
    'americanprogress.org':'Center for American Progress',
    'amnesty.org':'Amnesty International',
    'anandtech.com':'AnandTech',
    'ansa.it':'ANSA',
    'ap.news':'Associated Press',
    'ap.org':'Associated Press',
    'apnews.com':'Associated Press',
    'archive.org':'Internet Archive',
    'arstechnica.com':'Ars Technica',
    'as.com':'AS',
    'avclub.com':'The A.V. Club',
    'axios.com':'Axios',
    'barrons.com':'Barron\'s',
    'barstoolsports.com':'Barstool Sports',
    'bbc.co.uk':'BBC',
    'bbc.com':'BBC',
    'bellingcat.com':'Bellingcat',
    'bigtakeover.com':'The Big Takeover',
    'bleacherreport.com':'Bleacher Report',
    'bloody-disgusting.com':'Bloody Disgusting',
    'bloomberg.com':'Bloomberg',
    'bostonglobe.com':'The Boston Globe',
    'boxingnewsonline.net':'Boxing News',
    'boxofficemojo.com':'Box Office Mojo',
    'breitbart.com':'Breitbart',
    'britannica.com':'Encyclopedia Britannica',
    'brooklynvegan.com':'BrooklynVegan',
    'businessinsider.com':'Business Insider',
    'buzzfeed.com':'BuzzFeed',
    'buzzfeednews.com':'BuzzFeed News',
    'calciomercato.com':'Calciomercato',
    'cambridge.org':'Cambridge University Press',
    'cbc.ca':'CBC',
    'cbc.news':'CBC News',
    'cbslocal.com':'CBS Local',
    'cbsnews.com':'CBS News',
    'cbssports.com':'CBS Sports',
    'cdc.gov':'Centers for Disease Control and Prevention',
    'census.gov':'U.S. Census Bureau',
    'channelnewsasia.com':'Channel NewsAsia',
    'chicagotribune.com':'Chicago Tribune',
    'cia.gov':'CIA World Factbook',
    'cinemablend.com':'CinemaBlend',
    'clashmusic.com':'Clash Magazine',
    'cleveland.com':'Cleveland.com',
    'cnbc.com':'CNBC',
    'cnet.com':'CNET',
    'cnn.com':'CNN',
    'cnnespanol.cnn.com':'CNN en Espa√±ol',
    'cnnmoney.com':'CNN Money',
    'collider.com':'Collider',
    'comingsoon.net':'ComingSoon.net',
    'commondreams.org':'Common Dreams',
    'complex.com':'Complex',
    'consequenceofsound.net':'Consequence of Sound',
    'corriere.it':'Corriere della Sera',
    'corrieredellosport.it':'Corriere dello Sport',
    'cosmopolitan.com':'Cosmopolitan',
    'ctv.ca':'CTV',
    'ctvnews.ca':'CTV News',
    'curbed.com':'Curbed',
    'cyclingnews.com':'Cycling News',
    'dailycaller.com':'The Daily Caller',
    'dailymail.co.uk':'Daily Mail',
    'dailywire.com':'The Daily Wire',
    'dallasnews.com':'The Dallas Morning News',
    'deadline.com':'Deadline',
    'deadspin.com':'Deadspin',
    'decodedmagazine.com':'Decoded Magazine',
    'denverpost.com':'The Denver Post',
    'destructoid.com':'Destructoid',
    'digiday.com':'Digiday',
    'digitaltrends.com':'Digital Trends',
    'discovery.com':'Discovery',
    'downbeat.com':'DownBeat',
    'dualshockers.com':'DualShockers',
    'dutchnews.nl':'Dutch News',
    'dw.com':'Deutsche Welle',
    'economist.com':'The Economist',
    'efe.com':'EFE',
    'elconfidencial.com':'El Confidencial',
    'eldiario.es':'elDiario.es',
    'elle.com':'Elle',
    'elmundo.es':'El Mundo',
    'elpais.com':'El Pa√≠s',
    'elperiodico.com':'El Peri√≥dico',
    'engadget.com':'Engadget',
    'entrepreneur.com':'Entrepreneur',
    'eonline.com':'E! Online',
    'escapistmagazine.com':'The Escapist',
    'espn.com':'ESPN',
    'espnfc.com':'ESPN FC',
    'esquire.com':'Esquire',
    'etonline.com':'Entertainment Tonight',
    'eurogamer.net':'Eurogamer',
    'euronews.com':'Euronews',
    'europa.eu':'European Union',
    'ew.com':'Entertainment Weekly',
    'express.co.uk':'Daily Express',
    'extratv.com':'Extra TV',
    'fastcompany.com':'Fast Company',
    'fd.nl':'Het Financieele Dagblad',
    'fda.gov':'U.S. Food and Drug Administration',
    'filmmakermagazine.com':'Filmmaker Magazine',
    'filmschoolrejects.com':'Film School Rejects',
    'filmstage.com':'The Film Stage',
    'firstshowing.net':'FirstShowing.net',
    'flickeringmyth.com':'Flickering Myth',
    'fool.com':'The Motley Fool',
    'forbes.com':'Forbes',
    'fortune.com':'Fortune',
    'fourfourtwo.com':'FourFourTwo',
    'foxnews.com':'Fox News',
    'foxsports.com':'Fox Sports',
    'france24.com':'France 24',
    'franceinfo.fr':'France Info',
    'ft.com':'Financial Times',
    'gameinformer.com':'Game Informer',
    'gamerant.com':'Game Rant',
    'gamerevolution.com':'Game Revolution',
    'gamesindustry.biz':'GamesIndustry.biz',
    'gamespot.com':'GameSpot',
    'gamesradar.com':'GamesRadar+',
    'gametrailers.com':'GameTrailers',
    'gazzetta.it':'La Gazzetta dello Sport',
    'giantbomb.com':'Giant Bomb',
    'gizmodo.com':'Gizmodo',
    'glamour.com':'Glamour',
    'globalnews.ca':'Global News',
    'goal.com':'Goal.com',
    'goldderby.com':'Gold Derby',
    'golfmonthly.com':'Golf Monthly',
    'gov.uk':'UK Government',
    'gq.com':'GQ',
    'grubstreet.com':'Grub Street',
    'hardcoregamer.com':'Hardcore Gamer',
    'harpers.org':'Harper\'s Magazine',
    'harpersbazaar.com':'Harper\'s Bazaar',
    'health.com':'Health',
    'healthline.com':'Healthline',
    'heavy.com':'Heavy',
    'hollywoodreporter.com':'The Hollywood Reporter',
    'hotair.com':'Hot Air',
    'houstonchronicle.com':'Houston Chronicle',
    'huffingtonpost.it':'HuffPost Italia',
    'huffpost.com':'HuffPost',
    'ign.com':'IGN',
    'ilfattoquotidiano.it':'Il Fatto Quotidiano',
    'ilgiornale.it':'Il Giornale',
    'illustratemagazine.com':'Illustrate Magazine',
    'ilmessaggero.it':'Il Messaggero',
    'ilpost.it':'Il Post',
    'ilsole24ore.com':'Il Sole 24 Ore',
    'imf.org':'International Monetary Fund',
    'inc.com':'Inc.',
    'independent.co.uk':'The Independent',
    'indiewire.com':'IndieWire',
    'instyle.com':'InStyle',
    'investorsbusinessdaily.com':'Investor\'s Business Daily',
    'jazzjournal.co.uk':'Jazz Journal',
    'joblo.com':'JoBlo.com',
    'jstor.org':'JSTOR',
    'justjared.com':'Just Jared',
    'justjaredjr.com':'Just Jared Jr.',
    'kerrang.com':'Kerrang!',
    'kiplinger.com':'Kiplinger',
    'kotaku.com':'Kotaku',
    'larazon.es':'La Raz√≥n',
    'lastampa.it':'La Stampa',
    'latimes.com':'Los Angeles Times',
    'lavanguardia.com':'La Vanguardia',
    'lefigaro.fr':'Le Figaro',
    'lemonde.fr':'Le Monde',
    'leparisien.fr':'Le Parisien',
    'lepoint.fr':'Le Point',
    'lesechos.fr':'Les √âchos',
    'lexpres.fr':'L\'Express',
    'liberation.fr':'Lib√©ration',
    'lifehacker.com':'Lifehacker',
    'livescience.com':'Live Science',
    'macworld.com':'Macworld',
    'magneticmag.com':'Magnetic Magazine',
    'marca.com':'MARCA',
    'marieclaire.com':'Marie Claire',
    'marketwatch.com':'MarketWatch',
    'mashable.com':'Mashable',
    'mayoclinic.org':'Mayo Clinic',
    'mediaite.com':'Mediaite',
    'mediapart.fr':'Mediapart',
    'mediapost.com':'MediaPost',
    'menshealth.com':'Men\'s Health',
    'mercurynews.com':'The Mercury News',
    'merriam-webster.com':'Merriam-Webster',
    'metacritic.com':'Metacritic',
    'metro.co.uk':'Metro',
    'miamiherald.com':'Miami Herald',
    'mirror.co.uk':'The Mirror',
    'mixmag.net':'Mixmag',
    'mmogames.com':'MMOGames',
    'mmorpg.com':'MMORPG.com',
    'mojo4music.com':'MOJO',
    'money.com':'Money',
    'morningstar.com':'Morningstar',
    'motherjones.com':'Mother Jones',
    'motorsportmagazine.com':'Motor Sport Magazine',
    'movieweb.com':'MovieWeb',
    'msnbc.com':'MSNBC',
    'mundialmag.com':'MUNDIAL',
    'mundodeportivo.com':'Mundo Deportivo',
    'musicmayhemmagazine.com':'Music Mayhem Magazine',
    'nasa.gov':'NASA',
    'nationalgeographic.com':'National Geographic',
    'nationalpost.com':'National Post',
    'nationalreview.com':'National Review',
    'nature.com':'Nature',
    'nbclocal.com':'NBC Local',
    'nbcnews.com':'NBC News',
    'nbcsports.com':'NBC Sports',
    'ncbi.nlm.nih.gov':'NCBI',
    'news.co.nz':'Stuff.co.nz',
    'news.com.au':'News.com.au',
    'news.sky.com':'Sky News',
    'news.yahoo.com':'Yahoo News',
    'newscientist.com':'New Scientist',
    'newsweek.com':'Newsweek',
    'newyorker.com':'The New Yorker',
    'newyorkmag.com':'New York Magazine',
    'nextbestpicture.com':'Next Best Picture',
    'nintendolife.com':'Nintendo Life',
    'nist.gov':'National Institute of Standards and Technology',
    'nltimes.nl':'NL Times',
    'nobelprize.org':'Nobel Prize Organization',
    'nola.com':'The Times-Picayune',
    'nos.nl':'NOS',
    'nouvelobs.com':'L\'Obs',
    'npr.org':'NPR',
    'nrc.nl':'NRC',
    'nu.nl':'NU.nl',
    'nypost.com':'New York Post',
    'nytimes.com':'The New York Times',
    'nzherald.co.nz':'New Zealand Herald',
    'oecd.org':'Organisation for Economic Co-operation and Development',
    'orcz.com':'Orcz',
    'oregonian.com':'The Oregonian',
    'oregonlive.com':'OregonLive',
    'outsidemagazine.com':'Outside Magazine',
    'oxforddictionaries.com':'Oxford Dictionaries',
    'parool.nl':'Het Parool',
    'pbs.org':'PBS',
    'pcgamer.com':'PC Gamer',
    'pcmag.com':'PC Magazine',
    'pcworld.com':'PCWorld',
    'pennlive.com':'PennLive',
    'people.com':'People',
    'perezhilton.com':'Perez Hilton',
    'pitchfork.com':'Pitchfork',
    'politico.com':'Politico',
    'polygon.com':'Polygon',
    'popcrush.com':'PopCrush',
    'popsci.com':'Popular Science',
    'popsugar.com':'PopSugar',
    'prevention.com':'Prevention',
    'publico.es':'P√∫blico',
    'pubmed.ncbi.nlm.nih.gov':'PubMed',
    'purexbox.com':'Pure Xbox',
    'pushsquare.com':'Push Square',
    'rainews.it':'Rai News',
    'rawstory.com':'Raw Story',
    'reason.com':'Reason',
    'redstate.com':'RedState',
    'refinery29.com':'Refinery29',
    'repubblica.it':'la Repubblica',
    'reuters.com':'Reuters',
    'rfi.fr':'RFI',
    'rockpapershotgun.com':'Rock Paper Shotgun',
    'rogerebert.com':'RogerEbert.com',
    'rollingstone.com':'Rolling Stone',
    'rpgamer.com':'RPGamer',
    'rpgfan.com':'RPGFan',
    'rtl.nl':'RTL Nieuws',
    'rtve.es':'RTVE',
    'rugbyworld.com':'Rugby World',
    'runnersworld.com':'Runner\'s World',
    'sacbee.com':'The Sacramento Bee',
    'salon.com':'Salon',
    'sbnation.com':'SB Nation',
    'sciencedaily.com':'Science Daily',
    'sciencedirect.com':'ScienceDirect',
    'scientificamerican.com':'Scientific American',
    'scmp.com':'South China Morning Post',
    'screenjunkies.com':'Screen Junkies',
    'scriptnotes.net':'Script Notes',
    'seattletimes.com':'The Seattle Times',
    'seeking.com':'Seeking Alpha',
    'seventeen.com':'Seventeen',
    'sfchronicle.com':'San Francisco Chronicle',
    'sfgate.com':'SFGATE',
    'shacknews.com':'Shacknews',
    'shoot.co.uk':'Shoot Magazine',
    'si.com':'Sports Illustrated',
    'skimag.com':'SKI Magazine',
    'skysports.com':'Sky Sports',
    'slashfilm.com':'SlashFilm',
    'slate.com':'Slate',
    'smh.com.au':'Sydney Morning Herald',
    'smithsonianmag.com':'Smithsonian Magazine',
    'soccer360magazine.com':'Soccer360 Magazine',
    'soccer365.com':'Soccer365',
    'space.com':'Space.com',
    'spectator.org':'The American Spectator',
    'spin.com':'SPIN',
    'sport.es':'Sport',
    'startribune.com':'Star Tribune',
    'statesman.com':'Austin American-Statesman',
    'stereogum.com':'Stereogum',
    'straitstimes.com':'The Straits Times',
    'surfer.com':'Surfer Magazine',
    'swimswam.com':'SwimSwam',
    'tampabay.com':'Tampa Bay Times',
    'tapeop.com':'Tape Op',
    'techcrunch.com':'TechCrunch',
    'teenvogue.com':'Teen Vogue',
    'telegraaf.nl':'De Telegraaf',
    'telegraph.co.uk':'The Telegraph',
    'tennismagazine.com':'Tennis Magazine',
    'theage.com.au':'The Age',
    'theathletic.com':'The Athletic',
    'theatlantic.com':'The Atlantic',
    'theaustralian.com.au':'The Australian',
    'theblaze.com':'The Blaze',
    'theconversation.com':'The Conversation',
    'thecut.com':'The Cut',
    'thedailybeast.com':'The Daily Beast',
    'thegamer.com':'TheGamer',
    'theglobeandmail.com':'The Globe and Mail',
    'theguardian.com':'The Guardian',
    'thehill.com':'The Hill',
    'thescore.com':'theScore',
    'thesixthaxis.com':'TheSixthAxis',
    'thestar.com':'Toronto Star',
    'theverge.com':'The Verge',
    'thewest.com.au':'The West Australian',
    'thewrap.com':'TheWrap',
    'thinkprogress.org':'ThinkProgress',
    'time.com':'Time',
    'tmz.com':'TMZ',
    'tomshardware.com':'Tom\'s Hardware',
    'torontosun.com':'Toronto Sun',
    'townhall.com':'Townhall',
    'trouw.nl':'Trouw',
    'truthout.org':'Truthout',
    'tuttosport.com':'Tuttosport',
    'tv5monde.com':'TV5 Monde',
    'un.org':'United Nations',
    'unicef.org':'UNICEF',
    'upi.com':'United Press International',
    'uproxx.com':'Uproxx',
    'usatoday.com':'USA Today',
    'usmagazine.com':'Us Weekly',
    'vanityfair.com':'Vanity Fair',
    'variety.com':'Variety',
    'ventsmagazine.com':'Vents Magazine',
    'vg247.com':'VG247',
    'vibe.com':'Vibe',
    'videogamer.com':'VideoGamer.com',
    'vogue.com':'Vogue',
    'volkskrant.nl':'de Volkskrant',
    'vox.com':'Vox',
    'vulture.com':'Vulture',
    'washingtonpost.com':'The Washington Post',
    'webmd.com':'WebMD',
    'weeklystandard.com':'The Weekly Standard',
    'wegotthiscovered.com':'We Got This Covered',
    'whensaturdaycomes.co.uk':'When Saturday Comes',
    'who.int':'World Health Organization',
    'wired.com':'WIRED',
    'womenshealthmag.com':'Women\'s Health',
    'worldbank.org':'World Bank',
    'worldcat.org':'WorldCat',
    'worldsoccer.com':'World Soccer',
    'wsj.com':'The Wall Street Journal',
    'zdnet.com':'ZDNet'
  };
  return map[domain.toLowerCase()] || domain;
}

function convertCiteWebFamily(parsed, options){
  const params = parsed.params;
  const finalParams = {};
  const log = [];

  // Autoren (firstN/lastN), fallback first/last
  const authors = [];
  for(let i=1;i<=30;i++){
    const f = params['first'+i];
    const l = params['last'+i];
    if(f || l){ authors.push([f||'', l||''].filter(Boolean).join(' ').trim()); }
  }
  if(!authors.length && (params.first || params.last)){
    const n = [params.first||'', params.last||''].filter(Boolean).join(' ').trim();
    if(n) authors.push(n);
  }
  if(authors.length){ finalParams['autor'] = authors.join(', '); }

    // Titel (+ {{*}} ‚Üí ‚Ä¢ ; {{!}} ‚Üí ‚Äì ; Spacing normalisiert)
  if(params.title){
    const orig = String(params.title);
    let replaced = orig.replace(/\{\{\*\}\}/g, '\u2022');
    replaced = replaced.replace(/\{\{\s*!\s*\}\}/g, ' ‚Äì ');
    replaced = replaced.replace(/\s*‚Äì\s*/g, ' ‚Äì ');
    replaced = replaced.replace(/\s{2,}/g, ' ').trim();
    finalParams['titel'] = replaced;
  }




  // Zitat (quote -> zitat) mit gleichen Ersetzungen wie Titel
  if(params.quote){
    const qOrig = String(params.quote);
    let q = qOrig.replace(/\{\{\*\}\}/g, '\u2022');
    q = q.replace(/\{\{\s*!\s*\}\}/g, ' ‚Äì ');
    q = q.replace(/\s*‚Äì\s*/g, ' ‚Äì ');
    q = q.replace(/\s{2,}/g, ' ').trim();
    finalParams['zitat'] = q;
  }
  if(params.work){ finalParams['werk'] = params.work; }
  if(params.website){ finalParams['werk'] = finalParams['werk'] || params.website; }
  if(params.publisher){
    if(params.website){ finalParams['hrsg'] = params.publisher; }
    
  }
  if(!finalParams['werk'] && params.publisher){ finalParams['werk'] = params.publisher; }
  if(!finalParams['werk'] && params.url){
    var _site = (typeof getDisplaySiteNameFromUrl==='function' ? getDisplaySiteNameFromUrl(params.url) : '');
    if(!_site && typeof getDomainFromUrl==='function'){ _site = getDomainFromUrl(params.url); }
    if(_site){ finalParams['werk'] = _site; }
  }
    
  // continue building params
  if(params.url){
    finalParams['url'] = params.url;
    const lower = String(params.url).toLowerCase();
    const m = lower.match(/\.(pdf|pptx?|docx?|xlsx?)$/);
    if(m){
      const map = { pdf:'PDF', ppt:'PPT', pptx:'PPTX', doc:'DOC', docx:'DOCX', xls:'XLS', xlsx:'XLSX' };
      finalParams['format'] = map[m[1]] || m[1].toUpperCase();
    }
  }

  
const d = params['publication-date'] || params.date || params.year;
if(d){ const iso = toISODate(d); if(iso) finalParams['datum'] = iso; }

// Abruf: heute wenn Option aktiv, sonst access-date/accessdate/url-access
if(options.useToday){
  finalParams['abruf'] = todayISO();
} else {
  const acc = params['access-date'] || params.accessdate || params['url-access'];
  if(acc){ const isoA = toISODate(acc); if(isoA) finalParams['abruf'] = isoA; }
}

// Sprache: explicit ‚Üí override ‚Üí W√∂rterlisten/Heuristik
(function(){
  const lang = chooseLanguage(options.langChoice, params.language, params.title, (params.website || params.work || params.publisher || ''), options.overrideLang, options.fullLangCodes);
  if (lang) {
    if (!(options.suppressGerman && String(lang).toLowerCase().startsWith('de'))) {
      finalParams['sprache'] = lang;
    }
  }
})();

// Reihenfolge exakt wie gefordert
const order = ['autor','url','titel','titelerg','werk','hrsg','datum','seiten','format','sprache','offline','archiv-url','archiv-datum','archiv-bot','abruf','abruf-verborgen','kommentar','zitat','CH'];

// String bauen ‚Äì exakt ein Leerzeichen nach dem Templatenamen
const parts = [];
order.forEach(function(k){ if(finalParams[k]) parts.push('|' + k + '=' + finalParams[k]); });
const out = '{{Internetquelle ' + parts.join(' ') + '}}';
return { output: out, log };

}



  function convertCiteBook(parsed, options){
    const p = parsed.params; const F = {}; const log = [];

    let authors = collectPersons(p,'first','last');
    if(authors.length===0 && p['author']){ authors.push(p['author']); log.push('Autor: Einzelparameter author √ºbernommen'); }
    authors = authors.concat(collectPersons(p,'contributor-first','contributor-last'));
    authors = authors.concat(collectPersons(p,'interviewer-first','interviewer-last'));
    if(p['collaboration']){ authors.push(p['collaboration']); log.push('Autor: collaboration √ºbernommen'); }
    if(authors.length){ F['Autor'] = authors.join(', '); log.push('Autor: ' + authors.join(', ') + ' (zusammengesetzt)'); }

    let editors = collectPersons(p,'editor-first','editor-last');
    if(editors.length===0 && p['editor']){ editors.push(p['editor']); log.push('Hrsg: Einzelparameter editor √ºbernommen'); }
    if(editors.length){ F['Hrsg'] = editors.join(', '); log.push('Hrsg: ' + editors.join(', ')); }

    let translators = collectPersons(p,'translator-first','translator-last');
    if(translators.length===0 && p['translator']){ translators.push(p['translator']); log.push('√úbersetzer √ºbernommen'); }
    if(translators.length) F['√úbersetzer'] = translators.join(', ');

    if(p['title']){ F['Titel'] = p['title']; log.push('Titel √ºbernommen: ' + p['title']); }
    if(p['chapter']||p['script-chapter']){ F['Kapitel'] = p['chapter']||p['script-chapter']; log.push('Kapitel √ºbernommen: ' + (p['chapter']||p['script-chapter'])); }

    if(p['series']){ F['Reihe'] = p['series']; log.push('Reihe √ºbernommen'); }
    if(p['volume']){ F['Band'] = p['volume']; log.push('Band √ºbernommen'); }
    if(p['edition']){ F['Auflage'] = normalizeEdition(p['edition']); log.push('Auflage: ' + F['Auflage']); }

    if(p['publisher']){ F['Verlag'] = p['publisher']; log.push('Verlag √ºbernommen: ' + p['publisher']); }
    const ort = p['publication-place'] || p['location'];
    if(ort){ F['Ort'] = ort; log.push('Ort √ºbernommen: ' + ort); }

    const date = p['date'] || p['publication-date'] || p['year'];
    if(date){ F['Datum'] = toISODate(date); log.push('Datum √ºbernommen: ' + F['Datum']); }
    const orig = p['orig-date'] || p['origyear'] || p['orig-year'];
    if(orig){ F['Originaljahr'] = extractYear(orig); log.push('Originaljahr: ' + F['Originaljahr']); }

    const seiten = p['pages'] || p['page'] || p['at'];
    if(seiten){ F['Seiten'] = normalizePages(seiten); log.push('Seiten: ' + F['Seiten']); }

    const lang = chooseLanguage(options.langChoice, p['language'], F['Titel'], undefined, options.overrideLang, options.fullLangCodes);
    if(lang){
      if(!(options.suppressGerman && String(lang).toLowerCase().startsWith('de'))){
        F['Sprache'] = lang; log.push('Sprache automatisch erkannt: ' + lang);
      } else {
        log.push('Sprache wurde erkannt als de, wird aber unterdr√ºckt (Einstellung).');
      }
    }

    if(p['url']){ var _u = cleanOnlineValue(p['url']); if(_u) F['Online'] = _u; log.push('Online: URL √ºbernommen'); }
    if(options.useToday){ F['Abruf'] = todayISO(); log.push('Abruf: heutiges Datum gesetzt'); }
    else{ const ad = p['access-date'] || p['accessdate'] || p['url-access'] || ''; if(ad){ F['Abruf'] = toISODate(ad); log.push('Abruf: ' + F['Abruf']); } }

    if(p['format']) F['Format'] = p['format'];
    if(p['type']) F['Typ'] = p['type'];
    if(p['isbn']){ F['ISBN'] = normalizeISBN(p['isbn']); log.push('ISBN √ºbernommen'); }
    if(p['issn']) F['ISSN'] = p['issn'];
    if(p['doi']) F['DOI'] = p['doi'];
    if(p['jstor']) F['JSTOR'] = p['jstor'];
    if(p['lccn']) F['LCCN'] = p['lccn'];
    if(p['oclc']) F['OCLC'] = p['oclc'];
    if(p['pmc']) F['PMC'] = p['pmc'];
    if(p['pmid']) F['PMID'] = p['pmid'];
    if(p['arxiv']) F['arXiv'] = p['arxiv'];
    if(p['bibcode']) F['bibcode'] = p['bibcode'];
    if(p['urn']) F['URN'] = p['urn'];
    const asID = ['biorxiv','citeseerx','medrxiv','osti','ol','s2cid','zbl','mr','jfm','ssrn','rfc','hdl'];
    asID.forEach(k=>{ if(p[k]) F['ID'] = (F['ID'] ? (F['ID'] + ', ' + p[k]) : p[k]); });

    if(p['quote']){ F['Zitat'] = p['quote']; log.push('Zitat √ºbernommen'); }

    return { output: buildLiteratur(F), log };
  }

  
function convertCiteJournal(parsed, options){
  const p = parsed.params; const F = {}; const log = [];

  // Autor(en)
  let authors = collectPersons(p,'first','last');
  if (authors.length===0 && p['author']) { authors.push(p['author']); log.push('Autor: Einzelparameter author √ºbernommen'); }
  authors = authors.concat(collectPersons(p,'interviewer-first','interviewer-last'));
  if (p['collaboration']) { authors.push(p['collaboration']); log.push('Autor: collaboration √ºbernommen'); }
  if (authors.length) { F['Autor'] = authors.join(', '); log.push('Autor √ºbernommen'); }

  // Hrsg
  let editors = collectPersons(p,'editor-first','editor-last');
  if (editors.length===0 && p['editor']) { editors.push(p['editor']); log.push('Hrsg: Einzelparameter editor √ºbernommen'); }
  if (editors.length) { F['Hrsg'] = editors.join(', '); log.push('Hrsg √ºbernommen'); }

  // √úbersetzer
  let translators = collectPersons(p,'translator-first','translator-last');
  if (translators.length===0 && p['translator']) { translators.push(p['translator']); log.push('√úbersetzer √ºbernommen'); }
  if (translators.length) { F['√úbersetzer'] = translators.join(', '); log.push('√úbersetzer √ºbernommen'); }

  // Titel ({{*}} ‚Üí ‚Ä¢)
  if (p['title']) { F['Titel'] = String(p['title']).replace(/\{\{\*\}\}/g,'\u2022'); log.push('Titel √ºbernommen'); }

  // Sammelwerk / Band / Nummer
  if (p['journal']) { F['Sammelwerk'] = p['journal']; log.push('Sammelwerk √ºbernommen'); }
  if (p['volume']) { F['Band'] = p['volume']; log.push('Band √ºbernommen'); }
  if (p['issue']) { F['Nummer'] = String(p['issue']).replace(/\b(?:Nr\.?|No\.?)\b\s*/ig,'').trim(); log.push('Nummer √ºbernommen'); }

  // Sprache
  const lang = chooseLanguage(options.langChoice, p['language'], p['title'], p['journal'], options.overrideLang, options.fullLangCodes);
  if (lang) {
    if (!(options.suppressGerman && String(lang).toLowerCase().startsWith('de'))) {
      F['Sprache'] = lang;
      log.push(p['language'] ? ('Sprache √ºbernommen: ' + lang) : ('Sprache automatisch erkannt: ' + lang));
    } else {
      log.push('Sprache erkannt als de, aber unterdr√ºckt (Einstellung)');
    }
  }

  // Online / Abruf / Format
  if (p['url']) { var _u = cleanOnlineValue(p['url']); if(_u) F['Online'] = _u; log.push('Online √ºbernommen'); }
  const access = p['access-date'] || p['accessdate'] || p['url-access'];
  if (access) { F['Abruf'] = toISODate(access); log.push('Abruf: ' + F['Abruf']); }
  if (p['format']) { F['Format'] = p['format']; log.push('Format √ºbernommen'); }

  // Auflage / Ort / Verlag
  if (p['edition']) { F['Auflage'] = normalizeEdition(p['edition']); log.push('Auflage: ' + F['Auflage']); }
  if (p['publication-place']) { F['Ort'] = p['publication-place']; log.push('Ort √ºbernommen'); }
  if (p['publisher']) { F['Verlag'] = p['publisher']; log.push('Verlag √ºbernommen'); }

  // Datum / Originaljahr
  const date = p['publication-date'] || p['date'] || p['year'];
  if (date) { F['Datum'] = toISODate(date); log.push('Datum √ºbernommen: ' + F['Datum']); }
  const orig = p['orig-date'] || p['origyear'] || p['orig-year'];
  if (orig) { F['Originaljahr'] = extractYear(orig); log.push('Originaljahr: ' + F['Originaljahr']); }

  // Seiten
  const seiten = p['pages'] || p['page'] || p['at'];
  if (seiten) { F['Seiten'] = normalizePages(seiten); log.push('Seiten √ºbernommen: ' + F['Seiten']); }

  // IDs
  if (p['doi']) { F['DOI'] = p['doi']; log.push('DOI √ºbernommen'); }
  if (p['isbn']) { F['ISBN'] = normalizeISBN(p['isbn']); log.push('ISBN √ºbernommen'); }
  if (p['issn']) { F['ISSN'] = p['issn']; log.push('ISSN √ºbernommen'); }
  if (p['bibcode']) { F['bibcode'] = p['bibcode']; log.push('bibcode √ºbernommen'); }
  if (p['jstor']) { F['JSTOR'] = p['jstor']; log.push('JSTOR √ºbernommen'); }
  if (p['lccn']) { F['LCCN'] = p['lccn']; log.push('LCCN √ºbernommen'); }
  if (p['pmc']) { F['PMC'] = p['pmc']; log.push('PMC √ºbernommen'); }
  if (p['pmid']) { F['PMID'] = p['pmid']; log.push('PMID √ºbernommen'); }
  if (p['arxiv']) { F['arXiv'] = p['arxiv']; log.push('arXiv √ºbernommen'); }
  ['biorxiv','citeseerx','medrxiv','ol','osti','s2cid','zbl','id'].forEach(function(k){
    if (p[k]) {
      F['ID'] = (F['ID'] ? F['ID'] + '; ' : '') + p[k];
      log.push('ID erg√§nzt: ' + k + '=' + p[k]);
    }
  });

  // Reihe / Typ / Zitat
  if (p['series']) { F['Reihe'] = p['series']; log.push('Reihe √ºbernommen'); }
  if (p['type']) { F['Typ'] = p['type']; log.push('Typ √ºbernommen'); }
  if (p['quote']) { F['Zitat'] = p['quote']; log.push('Zitat √ºbernommen'); }

  const out = buildLiteratur(F);
  return { output: out, log };
}


function isCiteEncyclopedia(name){
  const n = (name||'').trim().toLowerCase();
  return n === 'cite encyclopedia';
}







function convertCiteEncyclopedia(parsed, options){
  const p = parsed.params; const F = {}; const log = [];

  // Autoren (firstN/lastN, first/last) + Interviewer + collaboration
  let authors = collectPersons(p,'first','last');
  // Interviewer erg√§nzen
  const interviewers = collectPersons(p,'interviewer-first','interviewer-last');
  if (interviewers.length) authors = authors.concat(interviewers);
  if (p.collaboration) authors.push(p.collaboration);
  if (authors.length){ F['Autor'] = authors.join(', '); }

  // √úbersetzer
  const translators = collectPersons(p,'translator-first','translator-last');
  if (translators.length) F['√úbersetzer'] = translators.join(', ');

  // Hrsg ‚Äì Schema A: editor-firstN/editor-lastN (inkl. unindiziert), via collectPersons
  let editors = collectPersons(p,'editor-first','editor-last');
  // Hrsg ‚Äì Schema B: editorN-first/editorN-last
  const numbered = [];
  Object.keys(p).forEach(k=>{
    const m = k.match(/^editor(\d+)-last$/i);
    if (m) numbered.push(parseInt(m[1],10));
  });
  numbered.sort((a,b)=>a-b);
  for (const i of numbered){
    const f = p[`editor${i}-first`] || '';
    const l = p[`editor${i}-last`]  || '';
    const name = (f + ' ' + l).trim();
    if (name) editors.push(name);
  }
  if (editors.length) F['Hrsg'] = editors.join(', ');

  // Titel / Kapitel
  if (p.title) F['Titel'] = p.title;
  else if (p.encyclopedia) F['Titel'] = p.encyclopedia;
  if (p['chapter']) F['Kapitel'] = p['chapter'];
  if (p['script-chapter']) F['Kapitel'] = p['script-chapter'];

  // Sprache
  if (p.language) F['Sprache'] = p.language;
  else if (typeof p.url === 'string'){
    const u = p.url.toLowerCase();
    if (u.includes('books.google') || u.includes('google books')) F['Sprache'] = 'en';
  } else if (p.url) {
    // Bei verschachtelten Templatedaten als URL (z. B. {{google books ...}}) setzen wir en heuristisch
    F['Sprache'] = F['Sprache'] || 'en';
  }

  // Sammelwerk / Reihe / Band / Auflage
  if (p.encyclopedia) F['Sammelwerk'] = p.encyclopedia;
  if (p.series)       F['Reihe']      = p.series;
  if (p.volume)       F['Band']       = p.volume;
  if (p.edition)      F['Auflage']    = normalizeEdition(p.edition);

  // Ort / Verlag
  const ort = p['publication-place'] || p['location'];
  if (ort)         F['Ort']   = ort;
  if (p.publisher) F['Verlag'] = p.publisher;

  // Datum / Originaljahr
  const d = p['publication-date'] || p['date'] || p['year'];
  if (d){
    const iso = toISODate(d);
    F['Datum'] = iso || String(d);
  }
  const orig = p['orig-date'] || p['orig-year'];
  if (orig){
    const y = String(orig).match(/\d{4}/);
    if (y) F['Originaljahr'] = y[0];
  }

  // Online / Abruf / Format
  var _u = cleanOnlineValue(p.url); if(_u) F['Online'] = _u;
  const access = p['url-access'] || p['access-date'];
  if (access){
    const a = toISODate(access);
    F['Abruf'] = a || String(access);
  }
  if (p.format)         F['Format'] = p.format;

  // Typ
  if (p.type)           F['Typ'] = p.type;

  // Seiten
  const pages = p['pages'] || p['page'] || p['at'];
  if (pages)            F['Seiten'] = normalizePages(pages);

  // IDs
  if (p.doi)            F['DOI']  = p.doi;
  if (p.isbn)           F['ISBN'] = normalizeISBN(p.isbn);
  if (p.issn)           F['ISSN'] = p.issn;
  if (p.jstor)          F['JSTOR'] = p.jstor;
  if (p.lccn)           F['LCCN'] = p.lccn;
  if (p.oclc)           F['OCLC'] = p.oclc;
  if (p.pmc)            F['PMC']  = p.pmc;
  if (p.pmid)           F['PMID'] = p.pmid;
  if (p.arxiv)          F['arXiv'] = p.arxiv;
  if (p.bibcode)        F['bibcode'] = p.bibcode;
  ['biorxiv','citeseerx','medrxiv','ol','osti','s2cid','zbl','id'].forEach(k=>{ if (p[k]) F['ID'] = p[k]; });

  return { output: buildLiteratur(F), log };
}










  function isCiteWebFamily(name){
  const n = (name||'').trim().toLowerCase();
  const aliases = ['cite web','cite website','cite webpage','cite news','cite magazine','internetquelle'];
  return aliases.indexOf(n) !== -1;
}

  function isCiteBook(name){ const n=(name||'').trim().toLowerCase(); return n==='cite book'; }
  function isCiteJournal(name){ const n=(name||'').trim().toLowerCase(); return n==='cite journal'; }

  function convertTemplateString(tplString, options){
    const parsed = parseTemplateParams(tplString);
    if(!parsed.name) return { output: tplString, log: ['Keine Template-Erkennung'] };
    if(isCiteBook(parsed.name)) return convertCiteBook(parsed, options);
    if(isCiteJournal(parsed.name)) return convertCiteJournal(parsed, options);
    if(isCiteWebFamily(parsed.name)) return convertCiteWebFamily(parsed, options);
        if(isCiteEncyclopedia(parsed.name)) return convertCiteEncyclopedia(parsed, options);
    return { output: tplString, log: ['Unver√§ndertes Template: ' + parsed.name] };
  }

  /* ----------------- Highlighting ----------------- */

  // basic tokenizer for template-like text (works for our templates)
  
function highlightTemplateText(text){
  if(!text) return '';
  // Safe escape
  let s = String(text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  // URLs first (keine Pipes/Braces zerst√∂ren)
  s = s.replace(/(https?:\/\/[^\s|}]+)/g, '<span class="tok-url">$1</span>');

  // Template-Name: {{ <ws> NAME <ws> (vor | oder }})
  s = s.replace(/\{\{(\s*)([^|}]+?)(\s*)(?=(\||\}\}))/g, function(_, ws1, name, ws2){
    return '{{' + ws1 + '<span class="tok-template">' + String(name).trim() + '</span>' + ws2;
  });

  // Braces danach einf√§rben
  s = s.replace(/(\{\{|\}\})/g, '<span class="tok-brace">$1</span>');

  // Parameter-Namen: | <ws> name <ws> =
  s = s.replace(/\|(\s*)([A-Za-z0-9\-\u00C0-\u017F]+)(\s*)=/g, function(_, ws1, name, ws2){
    return '|' + ws1 + '<span class="tok-param">' + name + '</span>' + ws2 + '<span class="tok-eq">=';
  });

  // Zahlen/Daten
  s = s.replace(/\b(\d{4}(-\d{2}(-\d{2})?)?)\b/g, '<span class="tok-number">$1</span>');

  // Klammer-Kommentare
  s = s.replace(/\(([^\)]+)\)/g, '(<span class="tok-comment">$1</span>)');

  // <ref>‚Ä¶</ref> (escapet)
  s = s.replace(/(&lt;\/?ref(?:\s+[^&]*?)?&gt;)/gi, '<span class="tok-ref">$1</span>');

  return s;
}
  function updateInputHighlight(){
    const txt = document.getElementById('inputText').value;
    const pre = document.getElementById('inputHighlight');
    pre.innerHTML = highlightTemplateText(txt);
  }
  function updateOutputHighlight(){
    const txt = document.getElementById('outputText').value;
    const pre = document.getElementById('outputHighlight');
    pre.innerHTML = highlightTemplateText(txt);
  }

  /* ----------------- Driver for transform + summary ----------------- */

  function transformTextAndReturnLog(){
  const inputEl = document.getElementById('inputText');
  const input = (inputEl.value || '').trim();
  const options = {
    useToday: document.getElementById('useTodayAbruf').checked,
    stripArchiveIfLive: document.getElementById('stripArchiveIfLive').checked,
    overrideLang: document.getElementById('overrideLang').checked,
    langChoice: (document.getElementById('langSelect') && document.getElementById('langSelect').value) || '',
    fullLangCodes: document.getElementById('fullLangCodes').checked,
    suppressGerman: document.getElementById('suppressGerman').checked
  };
  const log = [];

  if(!input){ return { result:'', log:['Keine Eingabe.'] }; }

  // Path A: convert inside each <ref>‚Ä¶</ref> (nesting-safe)
  const refRegex = /(<ref\b[^>]*>)([\s\S]*?)(<\/ref>)/gi;
  const resultA = input.replace(/(<ref\b[^>]*>)([\s\S]*?)(<\/ref>)/gi, function(full, refOpen, inner, refClose){
    const tpl = findFirstTopLevelTemplate(inner);
    if(!tpl){ return full; }
    const converted = convertTemplateString(tpl.text, options);
    if(converted.output === tpl.text){ return full; }
    return refOpen + inner.slice(0, tpl.start) + converted.output + inner.slice(tpl.end) + refClose;
  });

  // Path B: convert the first top-level template anywhere
  let resultB = input;
  const tplAll = findFirstTopLevelTemplate(input);
  if(tplAll){
    const converted = convertTemplateString(tplAll.text, options);
    if(converted.output !== tplAll.text){
      resultB = input.slice(0, tplAll.start) + converted.output + input.slice(tplAll.end);
    }
  }

  // Choose best result: prefer A if it changed anything; else B; else unchanged
  const changedA = (resultA !== input);
  const changedB = (resultB !== input);
  if(changedA) return { result: resultA, log };
  if(changedB) return { result: resultB, log };

  return { result: input, log:['Keine Template-Erkennung'] };
}
/* ----------------- DOM wiring ----------------- */

  document.addEventListener('DOMContentLoaded', function(){

    // set today label
    const tl = document.getElementById('todayLabel'); if(tl) tl.textContent = todayISO();

    // highlighting sync: update highlight initially
    const inputEl = document.getElementById('inputText');
    const outputEl = document.getElementById('outputText');
    updateInputHighlight(); updateOutputHighlight();

    // textarea event: update highlight on input
    inputEl.addEventListener('input', function(){
      updateInputHighlight();
    });

    // convert button
    document.getElementById('convertBtn').addEventListener('click', function(){
      const res = transformTextAndReturnLog();
      document.getElementById('outputText').value = res.result;
      updateOutputHighlight();

      // render the conversion summary in user-friendly text
      const sum = null;
      if(!res.log || res.log.length===0){ /* summary removed */ }
      else {
        const items = res.log.map(function(line){
          return '<li>' + escapeHtml(line) + '</li>';
        }).join('');
        /* summary removed */
      }

      // auto copy?
      if(document.getElementById('autoCopy').checked){
        const outText = document.getElementById('outputText').value || '';
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(outText).then(()=>{ document.getElementById('copyStatus').textContent='‚úì Direkt kopiert'; setTimeout(()=>document.getElementById('copyStatus').textContent='',1400); }).catch(()=>{});
        } else {
          try{ document.getElementById('outputText').select(); document.execCommand('copy'); document.getElementById('copyStatus').textContent='‚úì Direkt kopiert'; setTimeout(()=>document.getElementById('copyStatus').textContent='',1400);}catch(e){}
        }
      }
    });

    // copy button - always plain text from textarea (unformatted)
    document.getElementById('copyBtn').addEventListener('click', async function(){
      const out = document.getElementById('outputText').value || '';
      const status = document.getElementById('copyStatus');
      try{
        if(navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(out);
        } else {
          const ta = document.getElementById('outputText');
          ta.select(); document.execCommand('copy');
        }
        status.textContent = '‚úì In Zwischenablage kopiert';
        setTimeout(()=>status.textContent='',1800);
      }catch(err){
        console.warn('copy failed',err);
        status.textContent = '‚ö† Kopieren fehlgeschlagen';
        setTimeout(()=>status.textContent='',1800);
      }
    });

    // lang info toggle
    const infoBtn = document.getElementById('langInfoToggle');
    if(infoBtn) infoBtn.addEventListener('click',()=>{ const info=document.getElementById('langInfo'); if(info) info.style.display = (info.style.display==='none'?'block':'none'); });

    // overrideLang toggle
    const override = document.getElementById('overrideLang');
    const langContainer = document.getElementById('langSelectContainer');
    function updateLangContainer(){ langContainer.style.display = override.checked ? 'block' : 'none'; }
    override.addEventListener('change', updateLangContainer); updateLangContainer();

    // theme selection (unchanged logic)
    const themeOptions = Array.from(document.querySelectorAll('.theme-option'));
    function clearThemeClasses(){ Array.from(document.body.classList).forEach(c=>{ if(c.startsWith('theme-')) document.body.classList.remove(c); }); }
    function setTheme(name, persist=true){
      clearThemeClasses();
      if(name) document.body.classList.add('theme-'+name);
      themeOptions.forEach(el=>el.classList.toggle('active', el.dataset.theme===name));
      if(persist) localStorage.setItem('theme', name);
    }
    themeOptions.forEach(el=>{
      el.addEventListener('click', ()=> setTheme(el.dataset.theme));
      el.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); setTheme(el.dataset.theme); }});
    });
    const savedTheme = localStorage.getItem('theme') || 'sunset';
    setTheme(savedTheme, false);

    // force dark
    const fd = document.getElementById('forceDark');
    if(fd){
      const saved = localStorage.getItem('forceDark') === 'true';
      fd.checked = saved;
      if(saved) document.body.classList.add('force-dark');
      fd.addEventListener('change', ()=> {
        if(fd.checked){ document.body.classList.add('force-dark'); localStorage.setItem('forceDark','true'); }
        else { document.body.classList.remove('force-dark'); localStorage.setItem('forceDark','false'); }
        // caret color for overlay textarea is handled by css via body.force-dark
      });
    }

    // persist lang select
    const langSel = document.getElementById('langSelect');
    if(langSel){
      const savedLS = localStorage.getItem('langSelectValue');
      if(savedLS) langSel.value = savedLS;
      langSel.addEventListener('change', ()=> localStorage.setItem('langSelectValue', langSel.value));
    }

    // ensure highlight updates when output textarea changed programmatically
    const obs = new MutationObserver(updateOutputHighlight);
    obs.observe(document.getElementById('outputText'), { attributes:true, childList:true, characterData:true, subtree:true });

    // initial highlight
    updateInputHighlight();
    updateOutputHighlight();

    // keep focus behavior natural: clicking pre focuses the textarea
    document.getElementById('inputHighlight').addEventListener('click', ()=> document.getElementById('inputText').focus());
    document.getElementById('outputHighlight').addEventListener('click', ()=> document.getElementById('outputText').focus());
  });

})(); // IIFE


function cleanOnlineValue(val){
  if (val === undefined || val === null) return null;
  const s = String(val);
  // Entferne {{google books ...}}-Templates vollst√§ndig aus Online/URL
  if (/\{\{\s*google\s+books/i.test(s)) return null;
  return s;
}



function findFirstTopLevelTemplate(s){
  const start = s.indexOf('{{');
  if (start === -1) return null;
  let i = start;
  let depth = 0;
  while (i < s.length - 1){
    const a = s[i], b = s[i+1];
    if (a === '{' && b === '{'){ depth++; i += 2; continue; }
    if (a === '}' && b === '}' && depth > 0){
      depth--; i += 2;
      if (depth === 0){
        return { start, end: i, text: s.slice(start, i) };
      }
      continue;
    }
    i++;
  }
  return null;
}

</script>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const badge = document.getElementById("versionBadge");
  const log = document.getElementById("changelog");
  if(badge && log){
    badge.addEventListener("click", function(e){
      e.preventDefault();
      log.open = true;
      const sm = log.querySelector('summary');
      if(sm){ sm.setAttribute('aria-expanded','true'); }
      log.scrollIntoView({behavior:'smooth', block:'start'});
      if(history.replaceState){ history.replaceState(null, '', '#changelog'); }
    });
  }
});
</script>


<script>
document.addEventListener("DOMContentLoaded",()=>{
  const select=document.getElementById("darkModeSelect");
  if(select){
    const saved=localStorage.getItem("darkMode")||"auto";
    select.value=saved;
    applyDark(saved);
    select.addEventListener("change",()=>{
      localStorage.setItem("darkMode",select.value);
      applyDark(select.value);
    });
    if(saved==="auto"){
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener('change', ()=>{
        if(localStorage.getItem("darkMode")==="auto"){ applyDark("auto"); }
      });
    }
  }
  function applyDark(mode){
    document.body.classList.remove("force-dark","force-light");
    if(mode==="on"){ document.body.classList.add("force-dark"); }
    else if(mode==="off"){ document.body.classList.add("force-light"); }
    else{ // auto
      if(window.matchMedia('(prefers-color-scheme: dark)').matches){
        document.body.classList.add("force-dark");
      } else {
        document.body.classList.add("force-light");
      }
    }
  }
});
</script>


<script>
document.addEventListener("DOMContentLoaded", () => {
  const seg = document.getElementById("darkModeSegmented");
  const select = document.getElementById("darkModeSelect");
  if (!seg || !select) return;
  const buttons = Array.from(seg.querySelectorAll('button[data-value]'));

  function setPressed(value){
    buttons.forEach(btn => btn.setAttribute("aria-pressed", btn.dataset.value === value ? "true" : "false"));
  }

  // Init from select (set by existing script) or localStorage fallback
  const initial = select.value || localStorage.getItem("darkMode") || "auto";
  if (select.value !== initial) { select.value = initial; }
  setPressed(initial);

  // Click handler
  seg.addEventListener("click", (e) => {
    const btn = e.target.closest('button[data-value]');
    if (!btn) return;
    const val = btn.dataset.value;
    if (select.value !== val) {
      select.value = val;
      setPressed(val);
      select.dispatchEvent(new Event("change", { bubbles: true }));
    }
  });

  // Keyboard navigation (Left/Right/Home/End)
  seg.addEventListener("keydown", (e) => {
    if (!['ArrowLeft','ArrowRight','Home','End'].includes(e.key)) return;
    e.preventDefault();
    const currentIndex = buttons.findIndex(b => b.getAttribute("aria-pressed") === "true");
    let nextIndex = currentIndex >= 0 ? currentIndex : 0;
    if (e.key === 'ArrowRight') nextIndex = (currentIndex + 1) % buttons.length;
    if (e.key === 'ArrowLeft')  nextIndex = (currentIndex - 1 + buttons.length) % buttons.length;
    if (e.key === 'Home') nextIndex = 0;
    if (e.key === 'End')  nextIndex = buttons.length - 1;
    const nextBtn = buttons[nextIndex];
    const val = nextBtn.dataset.value;
    nextBtn.focus();
    if (select.value !== val) {
      select.value = val;
      setPressed(val);
      select.dispatchEvent(new Event("change", { bubbles: true }));
    }
  });
});
</script>



<script>
/* ===== CK Internetquelle Order/Lang Post-Processor v4.1.23 ===== */
(function(){
  function $(id){ return document.getElementById(id); }
  function fullLangEnabled(){
    var el = document.getElementById('fullLangCodes');
    return !!(el && el.checked);
  }
  function shortLang(v){ if(!v) return ''; return String(v).trim().split(/[-_]/)[0].toLowerCase(); }

  var IQ_ORDER = ['autor','url','titel','titelerg','werk','hrsg','datum','seiten','format','sprache','offline','archiv-url','archiv-datum','archiv-bot','abruf','abruf-verborgen','kommentar','zitat','CH'];

  (function(){
    var orig = window.buildInternetquelle;
    window.buildInternetquelle = function(F){
      try{
        var F2 = Object.assign({}, F || {});
        if(!fullLangEnabled() && typeof F2.sprache === 'string'){
          F2.sprache = shortLang(F2.sprache);
        }
        var parts = [];
        function has(v){ return v !== undefined && v !== null && String(v).trim() !== ''; }
        function push(k){ if(has(F2[k])) parts.push('|' + k + '=' + F2[k]); }
        IQ_ORDER.forEach(push);
        Object.keys(F2).forEach(function(k){ if(IQ_ORDER.indexOf(k) === -1) push(k); });
        return '{{Internetquelle ' + (parts.length ? ' ' + parts.join(' ') : '') + '}}';
      }catch(e){
        console.error('buildInternetquelle override failed', e);
        if(typeof orig === 'function') return orig(F);
        var raw=[]; for(var k in (F||{})) if(Object.prototype.hasOwnProperty.call(F,k)) raw.push('|'+k+'='+F[k]);
        return '{{Internetquelle ' + (raw.length? ' '+raw.join(' ') : '') + '}}';
      }
    };
  })();

  function findAllTopLevelTemplates(s){
    var res=[], dTpl=0, dLink=0, start=-1;
    for(var i=0;i<s.length-1;i++){
      var a=s[i], b=s[i+1];
      if(a==='[' && b==='['){ dLink++; i++; continue; }
      if(a===']' && b===']' && dLink>0){ dLink--; i++; continue; }
      if(a==='{' && b==='{' && dLink===0){ if(dTpl===0) start=i; dTpl++; i++; continue; }
      if(a==='}' && b==='}' && dTpl>0 && dLink===0){
        dTpl--; i++;
        if(dTpl===0 && start!==-1){
          var text=s.slice(start, i+1);
          res.push({ start:start, end:i+1, text:text });
          start=-1;
        }
        continue;
      }
    }
    return res;
  }

  function parseTemplate(tpl){
    if(!tpl || tpl.slice(0,2)!=='{{' || tpl.slice(-2)!=='}}') return null;
    var inner = tpl.slice(2, -2);
    var parts=[], buf='', dTpl=0, dLink=0;
    for(var i=0;i<inner.length;i++){
      var ch=inner[i], nx=inner[i+1];
      if(ch==='[' && nx==='['){ dLink++; buf+=ch; continue; }
      if(ch===']' && nx===']' && dLink>0){ dLink--; buf+=ch; continue; }
      if(ch==='{' && nx==='{' && dLink===0){ dTpl++; buf+=ch; continue; }
      if(ch==='}' && nx==='}' && dTpl>0 && dLink===0){ dTpl--; buf+=ch; continue; }
      if(ch==='|' && dTpl===0 && dLink===0){ parts.push(buf); buf=''; continue; }
      buf+=ch;
    }
    parts.push(buf);
    var name = (parts.shift()||'').trim();
    var params=[];
    for(var j=0;j<parts.length;j++){
      var p=parts[j];
      var m = p.match(/^\s*([^=|]+?)\s*=\s*([\s\S]*)$/);
      if(m){ params.push({ key: m[1].trim(), rawKey: m[1], val: m[2].trim() }); }
    }
    return { name:name, params:params };
  }

  function reorderInternetquelleInText(txt){
    if(!txt) return txt;
    var blocks = findAllTopLevelTemplates(txt);
    if(!blocks.length) return txt;
    var repl = [];
    for(var i=0;i<blocks.length;i++){
      var b = blocks[i];
      var parsed = parseTemplate(b.text);
      if(!parsed) continue;
      if(parsed.name.toLowerCase().replace(/\s+/g,' ') !== 'internetquelle') continue;

      var map = Object.create(null);
      var seen = [];
      for(var k=0;k<parsed.params.length;k++){
        var P = parsed.params[k];
        var key = String(P.key).trim();
        var keyL= key.toLowerCase();
        map[keyL] = { key:key, val:P.val };
        seen.push(key);
      }

      if(!fullLangEnabled() && map['sprache'] && typeof map['sprache'].val === 'string'){
        map['sprache'] = { key:'sprache', val: shortLang(map['sprache'].val) };
      }

      var parts = [];
      function hasVal(o){ return o && o.val !== undefined && String(o.val).trim() !== ''; }
      for(var q=0;q<IQ_ORDER.length;q++){
        var kq = IQ_ORDER[q];
        if(hasVal(map[kq])){ parts.push('|'+kq+'='+map[kq].val); delete map[kq]; }
      }
      for(var s=0;s<seen.length;s++){
        var origKey = seen[s], norm = origKey.toLowerCase();
        if(map[norm] && hasVal(map[norm])){
          parts.push('|'+map[norm].key+'='+map[norm].val);
          delete map[norm];
        }
      }
      var out = '{{Internetquelle ' + (parts.length? ' '+parts.join(' ') : '') + '}}';
      repl.push({ start:b.start, end:b.end, text: out });
    }
    if(!repl.length) return txt;
    repl.sort(function(a,b){ return b.start - a.start; });
    var res = txt;
    for(var r=0;r<repl.length;r++){
      res = res.slice(0, repl[r].start) + repl[r].text + res.slice(repl[r].end);
    }
    return res;
  }

  try{
    var btn = $('convertBtn');
    if(btn && !btn.dataset.ckIqOrderLangV4123){
      btn.dataset.ckIqOrderLangV4123 = "1";
      btn.addEventListener('click', function(){
        setTimeout(function(){
          var out = $('outputText');
          if(out && out.value){
            out.value = reorderInternetquelleInText(out.value);
            if(window.updateOutputHighlight) window.updateOutputHighlight();
          }
        }, 0);
      });
    }
  }catch(e){ console.error(e); }
})();
</script>
<script>
/* ===== CK Output-Display Sync Hotfix v4.1.26 ===== */
(function(){
  function $(id){ return document.getElementById(id); }
  function anyHighlighterPresent(){
    return (typeof window.updateOutputHighlight === 'function') ||
           (typeof window.refreshOutputHighlight === 'function') ||
           (typeof window.highlightOutput === 'function');
  }
  function refreshOutputView(){
    try{
      var out = $('outputText');
      if(!out) return;
      var usedHighlighter = false;
      // 1) Offizielle Highlighter benutzen (lassen HTML-Markup bestehen)
      try {
        if (typeof window.updateOutputHighlight === 'function'){ window.updateOutputHighlight(); usedHighlighter = true; }
        else if (typeof window.refreshOutputHighlight === 'function'){ window.refreshOutputHighlight(); usedHighlighter = true; }
        else if (typeof window.highlightOutput === 'function'){ window.highlightOutput(); usedHighlighter = true; }
      } catch(e){ /* ignore */ }
      // 2) Events, damit Debouncer/Observer feuern
      try {
        out.dispatchEvent(new Event('input', {bubbles:true}));
        out.dispatchEvent(new Event('change', {bubbles:true}));
        out.dispatchEvent(new KeyboardEvent('keyup', {bubbles:true, key:' '}));
      } catch(e){ /* ignore */ }
      // 3) Nur wenn KEIN Highlighter existiert oder sichtbar aktiv wurde ‚Üí Fallback-Text setzen
      function doFallbackIfNeeded(){
        if (anyHighlighterPresent()) {
          // Pr√ºfen, ob ein Overlay HTML-Markup gesetzt hat; wenn nicht, dennoch Fallback
          var over = document.getElementById('outputHighlight') ||
                     document.getElementById('outputCode') ||
                     document.querySelector('[data-output-highlight]') ||
                     document.querySelector('pre.output-highlight') ||
                     document.querySelector('.output-highlight') ||
                     document.querySelector('.highlight-output');
          if (over){
            var hasMarkup = /<span|<mark|<em|<strong/i.test(over.innerHTML || '');
            if (hasMarkup) return; // Highlight aktiv, nicht √ºberschreiben
          } else {
            // Kein Overlay-Element gefunden; dann Fallback setzen
          }
        } else {
          // Kein Highlighter vorhanden ‚Üí Fallback
        }
        var candidates = [
          document.getElementById('outputHighlight'),
          document.getElementById('outputCode'),
          document.querySelector('[data-output-highlight]'),
          document.querySelector('pre.output-highlight'),
          document.querySelector('.output-highlight'),
          document.querySelector('.highlight-output')
        ].filter(Boolean);
        candidates.forEach(function(el){
          if ('innerText' in el) el.innerText = out.value;
          else el.textContent = out.value;
        });
      }
      // zwei rAF Zyklen warten, damit evtl. Highlighter erst rendert
      if (window.requestAnimationFrame){
        requestAnimationFrame(function(){ requestAnimationFrame(doFallbackIfNeeded); });
      } else {
        setTimeout(doFallbackIfNeeded, 0);
      }
    }catch(e){ console.error(e); }
  }
  try{
    var btn=$('convertBtn');
    if(btn && !btn.dataset.ckOutputSyncV4126){
      btn.dataset.ckOutputSyncV4126="1";
      btn.addEventListener('click', function(){
        setTimeout(function(){ refreshOutputView(); }, 0);
      });
    }
  }catch(e){ console.error(e); }
})();

<script>
// Robust highlight + convert bootstrap (non-invasive)
(function(){
  function $(id){ return document.getElementById(id); }
  function markReady(){
    try{
      var pre = $('inputHighlight');
      if(pre && (pre.innerHTML || pre.textContent)) document.body.classList.add('hl-ready');
    }catch(e){}
  }
  function refreshHighlight(){
    try{ if(typeof window.updateInputHighlight==='function') window.updateInputHighlight(); }catch(e){}
    markReady();
  }
  function bindInput(){
    var ta = $('inputText'); if(!ta) return;
    if(ta.dataset.hlBound) return;
    ta.dataset.hlBound = "1";
    ta.addEventListener('input', refreshHighlight);
    ta.addEventListener('scroll', function(){ var pre=$('inputHighlight'); if(pre) pre.scrollTop = ta.scrollTop; });
    refreshHighlight();
  }
  function fallbackConvert(){
    try{
      var ta = $('inputText'), outEl = $('outputText');
      var input = ta && ta.value ? ta.value : '';
      if(!input.trim()) return;
      var opts = {
        useToday: !!$('useTodayAbruf')?.checked,
        stripArchiveIfLive: !!$('stripArchiveIfLive')?.checked,
        overrideLang: !!$('overrideLang')?.checked,
        langChoice: ($('langSelect') && $('langSelect').value) || '',
        fullLangCodes: !!$('fullLangCodes')?.checked,
        suppressGerman: !!$('suppressGerman')?.checked
      };
      if(typeof window.findFirstTopLevelTemplate!=='function' || typeof window.convertTemplateString!=='function'){
        return;
      }
      var blk = window.findFirstTopLevelTemplate(input);
      if(!blk || !blk.text) return;
      var conv = window.convertTemplateString(blk.text, opts) || {};
      var out = input.slice(0, blk.start) + (conv.output || blk.text) + input.slice(blk.end);
      if(outEl){ outEl.value = out; }
      try{ if(typeof window.updateOutputHighlight==='function') window.updateOutputHighlight(); }catch(e){}
    }catch(e){ /* swallow */ }
  }
  function bindConvert(){
    var btn = $('convertBtn'); if(!btn) return;
    if(btn.dataset.convBound) return;
    btn.dataset.convBound = "1";
    btn.addEventListener('click', function(){
      var ok = false, res=null;
      try{
        if(typeof window.transformTextAndReturnLog==='function'){
          res = window.transformTextAndReturnLog();
          if(res && typeof res.result==='string'){
            $('outputText').value = res.result || '';
            ok = true;
          }
        }
      }catch(e){ ok = false; }
      if(!ok){ fallbackConvert(); }
      try{ if(typeof window.updateOutputHighlight==='function') window.updateOutputHighlight(); }catch(e){}
    });
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ bindInput(); bindConvert(); refreshHighlight(); });
  }else{
    bindInput(); bindConvert(); refreshHighlight();
  }
})();
</script>

</body>
</html>